<!doctype html>
<html lang="es">
<head>
    <title>Programación Ensamblador - Magazine ZX número 17 - Marzo 2009</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" href="../css/magazine.css" type="text/css">
</head>
<body>
<table bgcolor="#F9F9FF" border="0" cellspacing="0" cellpadding="0" width="720">
    <tr>
        <td>
            <a name="arriba"></a>
            <table border="0" cellspacing="0" cellpadding="4" width="720" bgcolor="#EEEEEE">
                <tr align="center" valign="center">
                    <td><a href="/"><img src="../img/logo_grande.gif" width="174" height="87" border="0"/></a></td>
                </tr>
            </table>
        </td>

    </tr>
    <tr>
        <td>
            <script language="JavaScript">
              function RecargarCabecera(url) {
                document.location = url;
              }
            </script>
            <table border="0" cellspacing="0" cellpadding="6" width="720" class="texto" bgcolor="#DDDDDD">
                <form name="selector_secciones">
                    <tr>
                        <td colspan="4" align="center" bgcolor="#FFFFFF" class="texto">> <a href="/lista-revistas.html"><b>ÍNDICE
                            DE REVISTAS</b></a> <
                        </td>
                    </tr>

                    <tr>
                        <td align="left">
                            <input type="button" onclick="RecargarCabecera('z88dk.html');" name="anterior" value="<"/>
                            <select onChange="RecargarCabecera(this.options[this.selectedIndex].value);">
                                <option value="index.html">Portada</option>
                                <option value="editorial.html">Índice - Editorial</option>
                                <option value="panorama.html">Panorama</option>
                                <option value="la-historia-del-spectrum.html">La historia del Spectrum</option>

                                <option value="el-aventurero.html">El Aventurero</option>
                                <option value="analisis.html">Análisis</option>
                                <option value="computone.html">Computone</option>
                                <option value="al-descubierto.html">Al Descubierto</option>
                                <option value="basic.html">Programación BASIC</option>
                                <option value="z88dk.html">Programación Z88DK</option>

                                <option value="ensamblador.html" selected>Programación Ensamblador</option>
                                <option value="128k-mode.html">128K MODE</option>
                                <option value="input.html">INPUT</option>
                                <option value="tira-comica.html">Tira cómica</option>
                                <option value="opinion.html">Opinión</option>
                            </select>

                            <input type="button" onclick="RecargarCabecera('128k-mode.html');" name="siguiente"
                                   value=">"/>
                        </td>
                        <td align="center" class="texto">Número 17 - Marzo 2009</td>
                        <td align="right"><a href="http://www.worldofspectrum.org/viewcert.cgi?candidate=Magazine+ZX"
                                             onClick="window.open(this.href); return false;"><img
                                src="https://www.worldofspectrum.org/pics/zxcert.png" width="87" height="30" border="0"
                                alt="ZX Certified webmaster"></a> <a href="http://www.speccy.org/"
                                                                     onClick="window.open(this.href); return false;"><img
                                src="../img/logo_speccyorg.gif" border="0" width="121" height="30" alt="speccy.org"></a>
                        </td>
                    </tr>
                </form>
            </table>
            </a>
        </td>
    </tr>

    <tr>
        <td> </td>
    </tr>
    <tr>
        <td>
            <style type="text/css">
                table.flags {
                    background: grey;
                    margin: 0;
                    padding: 0;
                }

                table.flags td, table.flags th {
                    background: white;
                    margin: 0;
                    padding: 4px;
                }
            </style>
            <table border="0" cellspacing="0" cellpadding="8" width="720" class="texto">
                <tr>
                    <td>
                        <div align="justify">
                            <p>En este último número de la revista hacemos una promoción 2x1. Llévese los dos últimos
                                artículos del curso de ensamblador por el precio de uno.</p>
                            <p align="center"><font size="5">Lenguaje Ensamblador del Z80 (IV)</font></p>

                            <p><b>La pila y las llamadas a subrutinas</b></p>
                            <p> Los 2 temas que vamos a tratar hoy, la pila por un lado y las llamadas a subrutinas por
                                otro, están íntimamente relacionados. Como veremos, la pila del Spectrum es aquello que
                                permite la utilización de rutinas a las que pasaremos parámetros, y que volverán al
                                punto donde fueron llamadas tras su ejecución.</p>
                            <p><strong>La pila del Spectrum</strong></p>
                            <p>Hoy vamos a tratar una de las cosas más importantes del microprocesador Z80: <b>la
                                pila</b> o <b>Stack</b> (en inglés).</p>
                            <p>La pila, teóricamente, es <em>una porción de memoria donde se pueden almacenar valores de
                                16 bits</em>.</p>

                            <p>Su nombre viene del hecho que los datos se almacenan unos encima de otros, como en una
                                pila de platos. Cuando almacenamos un nuevo plato en una pila, lo dejamos encima del
                                todo de la misma, sobre el plato anterior. Cuando queremos coger un plato, cogemos el
                                plato más alto, el que está en la parte más alta de la pila.</p>
                            <p>Las pilas son una estructura de datos conocida como estructura LIFO: Last In, First
                                Out: el último que entró es el primero que sale. En nuestro ejemplo de los platos,
                                efectivamente cuando retiramos un plato (el primero que sale) extraemos el que está
                                arriba del todo (el último que habíamos dejado). En una pila de ordenador (como en
                                nuestra pila de datos) sólo podemos trabajar con el dato (o plato) que está arriba del
                                todo de la pila: no podemos extraer uno de los platos intermedios. Sólo podemos apilar
                                un plato nuevo y desapilar el plato apilado arriba del todo de la pila.</p>
                            <p>
                            <p>La pila del Spectrum no es de platos sino de valores numéricos de 16 bits. Introducimos
                                valores y sacamos valores mediante 2 instrucciones concretas: <b>PUSH
                                    <valor>
                                </b> y <b>POP
                                    <valor>
                                </b>, donde normalmente
                                <valor> será un registro (metemos en la pila el valor que contiene un registro de 16
                                    bits, o bien leemos de la pila un valor y lo asignamos a un registro de 16 bits).
                            </p>

                            <p>Por ejemplo, podemos guardar el valor que contiene un registro en la pila si tenemos que
                                hacer operaciones con ese registro para así luego recuperarlo tras realizar la tarea que
                                tengamos que realizar:</p>
                            <table border="0" cellspacing="0" cellpadding="4" width="100%" bgcolor="#EAE8A9">
                                <tr>
                                    <td><p class="codigo">
                                        <pre>
 LD BC, 1000
 PUSH BC         ; Guardamos el contenido de BC en la pila

 LD BC, 2000
 (...)           ; Operamos con BC

 LD HL, 0
 ADD HL, BC      ; y ya podemos guardar el resultado de la operación
                 ; (recordemos que no existe "LD HL, BC", de modo que
                 ; lo almacenamos como HL = 0+BC

 POP BC          ; Hemos terminado de trabajar con BC, ahora
                 ; recuperamos el valor que tenia BC=1000.
</pre>
                                        </p></td>
                                </tr>
                            </table>
                            <p>La instrucción PUSH BC lo que ha hecho es introducir en memoria, en lo alto de la pila,
                                el valor 1000, que recuperamos posteriormente con el POP BC.</p>
                            <p>La realidad es que <em>el Spectrum no tiene una zona de memoria especial o aislada de la
                                RAM dedicada a la pila. En su lugar se utiliza la misma RAM del Spectrum (0-65535)</em>.
                            </p>

                            <p>El Z80 tiene un registro conocido como <b>SP (Stack Pointer)</b>, o <b>puntero de
                                pila</b>, que es un registro de 16 bits que contiene una dirección de memoria. Esa
                                dirección de memoria es <em>la cabeza de la pila</em>: apunta al próximo lugar donde
                                almacenaremos un dato (al hueco donde guardaremos el próximo plato).</p>
                            <p>La peculiaridad de la pila del Spectrum es que <em>crece hacia abajo</em>, en lugar de
                                hacia arriba. Veamos un ejemplo práctico:</p>


                            <table border="0" cellspacing="0" cellpadding="2" width="465">
                                <tr align="right">

                                    <td><img src="img/pila_z80.png" width="465" height="229"
                                             alt="Como crece y decrece la pila del Z80"/>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="piefoto" align="right">Como crece y decrece la pila del Z80</td>
                                </tr>
                            </table>


                            <p>Supongamos que SP (puntero de pila) apunta a 65535 (la última posición de la memoria).
                                Hagamos una serie de PUSHes y POPs de registros de 16 bits. Sea el siguiente
                                programa:</p>


                            <table border="0" cellspacing="0" cellpadding="4" width="100%" bgcolor="#EAE8A9">
                                <tr>
                                    <td><p class="codigo">
                                        <pre>
 LD BC, 00FFh
 LD DE, AABBh
 LD SP, 65535     ; Puntero de pila al final de la memoria
</pre>
                                        </p></td>
                                </tr>
                            </table>

                            <p>Si ahora hacemos:</p>

                            <table border="0" cellspacing="0" cellpadding="4" width="100%" bgcolor="#EAE8A9">
                                <tr>
                                    <td><p class="codigo">

                                        <pre>
 PUSH BC          ; Apilamos el registro BC
</pre>
                                        </p></td>
                                </tr>
                            </table>

                            <p>Lo que estaremos haciendo es:</p>

                            <table border="0" cellspacing="0" cellpadding="4" width="100%" bgcolor="#EAE8A9">
                                <tr>
                                    <td><p class="codigo">
                                        <pre>
 SP = SP - 2 = 65533
 (SP) = BC = 00FFh

</pre>
                                        </p></td>
                                </tr>
                            </table>

                            <p>Con lo que el contenido de la memoria sería:</p>

                            <table class="flags">
                                <tr>
                                    <th></th>
                                    <th>Celdilla</th>
                                    <th>Contenido</th>
                                </tr>
                                <tr>
                                    <td></td>
                                    <td>65534</td>
                                    <td>FFh</td>
                                </tr>
                                <tr>
                                    <td>SP -></td>
                                    <td>65533</td>
                                    <td>00h</td>
                                </tr>

                            </table>

                            <p>Si a continuación hacemos otro PUSH:</p>

                            <table border="0" cellspacing="0" cellpadding="4" width="100%" bgcolor="#EAE8A9">
                                <tr>
                                    <td><p class="codigo">
                                        <pre>
 PUSH DE          ; Apilamos el registro DE
</pre>
                                        </p></td>
                                </tr>
                            </table>

                            <p>Lo que estaremos haciendo es:</p>

                            <table border="0" cellspacing="0" cellpadding="4" width="100%" bgcolor="#EAE8A9">
                                <tr>
                                    <td><p class="codigo">
                                        <pre>
 SP = SP - 2 = 65531
 (SP) = DE = AABBh
</pre>
                                        </p></td>
                                </tr>
                            </table>

                            <p>Con lo que el contenido de las celdillas de memoria sería:</p>

                            <table class="flags">
                                <tr>
                                    <th></th>
                                    <th>Celdilla</th>
                                    <th>Contenido</th>
                                </tr>

                                <tr>
                                    <td></td>
                                    <td>65534</td>
                                    <td>FFh</td>
                                </tr>
                                <tr>
                                    <td></td>
                                    <td>65533</td>
                                    <td>00h</td>
                                </tr>
                                <tr>
                                    <td></td>
                                    <td>65532</td>
                                    <td>AAh</td>
                                </tr>
                                <tr>
                                    <td>SP -></td>
                                    <td>65531</td>
                                    <td>BBh</td>
                                </tr>
                            </table>


                            <p>Si ahora hacemos un POP:</p>

                            <table border="0" cellspacing="0" cellpadding="4" width="100%" bgcolor="#EAE8A9">
                                <tr>
                                    <td><p class="codigo">
                                        <pre>
 POP DE
</pre>
                                        </p></td>
                                </tr>
                            </table>

                            <p>Lo que hacemos es:</p>

                            <table border="0" cellspacing="0" cellpadding="4" width="100%" bgcolor="#EAE8A9">
                                <tr>
                                    <td><p class="codigo">

                                        <pre>
 DE = (SP) = AABBh
 SP = SP + 2 = 65533
</pre>
                                        </p></td>
                                </tr>
                            </table>

                            <p>Y la memoria queda, de nuevo, como:</p>
                            <table class="flags">
                                <tr>
                                    <th></th>
                                    <th>Celdilla</th>
                                    <th>Contenido</th>
                                </tr>
                                <tr>
                                    <td></td>
                                    <td>65534</td>
                                    <td>FFh</td>
                                </tr>

                                <tr>
                                    <td>SP -></td>
                                    <td>65533</td>
                                    <td>00h</td>
                                </tr>
                            </table>


                            <p>Como podemos ver, <em>PUSH va apilando valores</em>, haciendo decrecer el valor de SP,
                                mientras que <em>POP recupera valores</em>, haciendo crecer (en 2 bytes, 16 bits)
                                el valor de SP.</p>

                            <p><strong>PUSH y POP</strong></p>
                            <p>Así pues, podemos hacer <b>PUSH</b> y <b>POP</b> de los siguientes registros:</p>

                            <ul>
                                <li>PUSH: AF, BC, DE, HL, IX, IY</li>
                                <li>POP : AF, BC, DE, HL, IX, IY</li>
                            </ul>
                            <p>Lo que hacen PUSH y POP, tal y como funciona la pila, es:</p>
                            <table border="0" cellspacing="0" cellpadding="4" width="100%" bgcolor="#EAE8A9">
                                <tr>
                                    <td><p class="codigo">
                                        <pre>
 PUSH xx :
   SP   = SP-2
   (SP) = xx

 POP xx :
   xx   = (SP)
   SP   = SP+2
</pre>

                                        </p></td>
                                </tr>
                            </table>

                            <p>Nótese cómo la pila se decrementa ANTES de poner los datos en ella, y se incrementa
                                DESPUES de sacar datos de la misma. Esto mantiene siempre SP apuntando al TOS (<em>Top
                                    Of Stack</em>).</p>
                            <table border="0" cellspacing="0" cellpadding="4" width="100%" bgcolor="#EAE8A9">
                                <tr>
                                    <td><p class="codigo">
                                        <pre>
                        Flags
   Instrucción       |S Z H P N C|
 ----------------------------------
 POP xx              |- - - - - -|
 PUSH xx             |- - - - - -|
</pre>
                                        </p></td>
                                </tr>

                            </table>

                            <p>Nótese que también podemos apilar y desapilar AF. De hecho, es una forma de manipular los
                                bits del registro F (hacer PUSH BC con un valor determinado, por ejemplo, y hacer un POP
                                AF).</p>

                            <p><strong>Utilidad de la pila del Spectrum</strong></p>
                            <p>La pila resulta muy útil para gran cantidad de tareas en programas en ensamblador. Veamos
                                algunos ejemplos:</p>
                            <ul>
                                <li>Intercambiar valores de registros mediante PUSH y POP. Por ejemplo, para
                                    intercambiar el valor de BC y de DE:
                                </li>
                            </ul>
                            <table border="0" cellspacing="0" cellpadding="4" width="100%" bgcolor="#EAE8A9">
                                <tr>
                                    <td><p class="codigo">

                                        <pre>
 PUSH BC  ; Apilamos BC
 PUSH DE  ; Apilamos DE
 POP BC   ; Desapilamos BC
          ; ahora BC=(valor apilado de DE)
 POP DE   ; Desapilamos DE
          ; ahora DE=(valor apilado de BC)
</pre>
                                        </p></td>
                                </tr>
                            </table>

                            <ul>
                                <li>POP AF es la principal forma de manipular el registro F directamente (haciendo PUSH
                                    de otro registro y POP de AF).
                                </li>
                                <li>Almacenaje de datos mientras ejecutamos porciones de código: Supongamos que tenemos
                                    un registro cuyo valor queremos mantener, pero que tenemos que ejecutar una porción
                                    de código que lo modifica. Gracias a la pila podemos hacer lo siguiente:
                                </li>
                            </ul>
                            <table border="0" cellspacing="0" cellpadding="4" width="100%" bgcolor="#EAE8A9">

                                <tr>
                                    <td><p class="codigo">
                                        <pre>
 PUSH BC    ; Guardamos el valor de BC
 (código)   ; Hacemos operaciones
 POP BC     ; Recuperamos el valor que teníamos en BC
</pre>
                                        </p></td>
                                </tr>
                            </table>

                            <p>Esto incluye, por ejemplo, el almacenaje del valor de BC en los bucles cuando necesitamos
                                operador con B, C o BC:</p>
                            <table border="0" cellspacing="0" cellpadding="4" width="100%" bgcolor="#EAE8A9">
                                <tr>
                                    <td><p class="codigo">
                                        <pre>
    LD A, 0
    LD B, 100
bucle:
    PUSH BC     ; Guardamos BC
    LD B, 1
    ADD A, B
    POP BC      ; Recuperamos BC
    DJNZ bucle

</pre>
                                        </p></td>
                                </tr>
                            </table>

                            <p>En este sentido, también podremos anidar 2 o más bucles que usen el registro B o BC con
                                PUSH y POPs entre ellos. Supongamos un bucle BASIC del tipo:</p>
                            <table border="0" cellspacing="0" cellpadding="4" width="100%" bgcolor="#EAE8A9">
                                <tr>
                                    <td><p class="codigo">
                                        <pre>
  FOR I=0 TO 20:
    FOR J=0 TO 100:
       CODIGO
    NEXT J
  NEXT I
</pre>
                                        </p></td>
                                </tr>
                            </table>

                            <p>En ensamblador podríamos hacer:</p>
                            <table border="0" cellspacing="0" cellpadding="4" width="100%" bgcolor="#EAE8A9">
                                <tr>
                                    <td><p class="codigo">
                                        <pre>
    LD B, 20                ; repetimos bucle externo 20 veces

bucle_externo:
    PUSH BC                 ; Nos guardamos el valor de BC
    LD B, 100               ; Iteraciones del bucle interno
bucle_interno:
    (... código ...)
    DJNZ bucle_interno      ; FOR J=0 TO 100
    POP BC                  ; Recuperamos el valor de B

    DJNZ bucle_externo      ; FOR I=0 TO 20
</pre>
                                        </p></td>
                                </tr>
                            </table>

                            <p>Hay que tener en cuenta que PUSH y POP implican escribir en memoria (en la dirección
                                apuntada por SP), por que siempre serán más lentas que guardarse el valor actual de B en
                                otro registro:</p>
                            <table border="0" cellspacing="0" cellpadding="4" width="100%" bgcolor="#EAE8A9">

                                <tr>
                                    <td><p class="codigo">
                                        <pre>
    LD B, 20                ; repetimos bucle externo 20 veces

bucle_externo:
    LD D, B                 ; Nos guardamos el valor de B

    LD B, 100               ; Iteraciones del bucle interno
bucle_interno:
    (... código ...)        ; En este codigo no podemos usar D
    DJNZ bucle_interno      ; FOR J=0 TO 100

    LD B, D                 ; Recuperamos el valor de B

    DJNZ bucle_externo      ; FOR I=0 TO 20
</pre>
                                        </p></td>
                                </tr>
                            </table>

                            <p>No obstante, en múltiples casos nos quedaremos sin registros libres donde guardar datos,
                                por lo que la pila es una gran opción. No hay que obsesionarse con no usar la pila
                                porque implique escribir en memoria. A menos que estemos hablando de una rutina muy muy
                                crítica, que se ejecute muchas veces por cada fotograma de nuestro juego, PUSH y POP
                                serán las mejores opciones para preservar valores.</p>
                            <ul>
                                <li>Almacenaje de datos de entrada y salida en subrutinas: Podemos pasar parámetros a
                                    nuestras rutinas apilándolos en el stack, de forma que nada más entrar en la rutina
                                    leamos de la pila esos parámetros.
                                </li>
                                <li>Extendiendo un poco más el punto anterior, cuando realicemos funciones en
                                    ensamblador embebidas dentro de otros lenguajes (por ejemplo, dentro de programas en
                                    C con Z88DK), podremos recoger dentro de nuestro bloque en ensamblador los
                                    parámetros pasados con llamadas de funciones C.
                                </li>

                                <li>Como veremos en el próximo apartado, la pila es la clave de las subrutinas
                                    (CALL/RET) en el Spectrum (equivalente al GOSUB/RETURN de BASIC).
                                </li>
                            </ul>
                            <p>Recordad también que tenéis instrucciones de intercambio (EX) que permiten manipular la
                                pila. Hablamos de:</p>
                            <table border="0" cellspacing="0" cellpadding="4" width="100%" bgcolor="#EAE8A9">
                                <tr>
                                    <td><p class="codigo">
                                        <pre>
 EX (SP), HL
 EX (SP), IX
 EX (SP), IY
</pre>
                                        </p></td>
                                </tr>
                            </table>

                            <p><strong>Los peligros de la pila</strong></p>
                            <p>Pero como todo arma, las pilas también tienen un doble filo. Mal utilizada puede dar
                                lugar a enormes desastres en nuestros programas. Veamos algunos de los más
                                habituales:</p>
                            <ul>
                                <li>Dado que la pila decrece en memoria, tenemos que tener cuidado con el valor de SP y
                                    la posición más alta de memoria donde hayamos almacenado datos o rutinas. Si ponemos
                                    un gráfico o una rutina cerca del valor inicial de SP, y realizamos muchas
                                    operaciones de PUSH, podemos machacar nuestros datos con los valores de los
                                    registros que estamos apilando.
                                </li>
                                <li>Hacer más PUSH que POP o más POP que PUSH. Recordemos que la pila tiene que ser
                                    consistente. Si hacemos un push, debemos recordar hacer el pop correspondiente (a
                                    menos que haya una razón para ello), y viceversa. Como veremos a continuación, la
                                    pila es utilizada tanto para pasar parámetros a funciones como para volver de ellas,
                                    si introducimos un valor en ella con PUSH dentro de una función y no lo sacamos
                                    antes de hacer el RET, nuestro programa continuará su ejecución el algún lugar de la
                                    memoria que no era al que debía volver. Es más, si nuestro programa debe volver a
                                    BASIC correctamente tras su ejecución, entonces es obligatorio que hagamos tantos
                                    PUSH como POP para que el punto final de retorno del programa al BASIC esté en la
                                    siguiente posición de la pila cuando nuestro programa acabe.
                                </li>
                                <li>Ampliando la regla anterior, hay que tener cuidado con los bucles a la hora de hacer
                                    PUSH y POP.
                                </li>
                                <li>Finalmente, no hay que asumir que SP tiene un valor correcto para nosotros. Tal vez
                                    tenemos planeado usar una zona de la memoria para guardar datos o subrutinas y el
                                    uso de PUSH y POP pueda machacarlo. Si sabemos dónde no puede hacer daño SP y sus
                                    escrituras en memoria, basta con inicializar la pila al principio de nuestro
                                    programa a una zona de memoria libre (por ejemplo, LD SP, 23999, o cualquier otra
                                    dirección que sepamos que no vamos a usar). Esto no es obligatorio y muchas veces el
                                    valor por defecto de SP será válido, siempre que no usemos zonas de la memoria que
                                    creemos libres como almacenes temporales. Si usamos variables creadas en tiempo
                                    de ensamblado (definidas como DB o DW en el ensamblador) no deberíamos tener
                                    problemas, al menos con programas pequeños.
                                </li>

                            </ul>
                            <p>Veamos algunos ejemplos de errores con la pila. Empecemos con el típico PUSH del cual
                                se nos olvida hacer POP:</p>
                            <table border="0" cellspacing="0" cellpadding="4" width="100%" bgcolor="#EAE8A9">
                                <tr>
                                    <td><p class="codigo">
                                        <pre>
  ; Este programa se colgará (probablemente, depende de BC)
  ; pero en cualquier caso, no seguirá su ejecución normal.
  PUSH BC
  PUSH DE

  (código)

  POP DE
  RET          ; En lugar de volver a la dirección de memoria
               ; a la que teníamos que volver, volveremos a
               ; la dirección apuntada por el valor de BC, que
               ; no hemos recogido de la pila.
</pre>
                                        </p></td>
                                </tr>
                            </table>

                            <p>También hay que tener cuidado con los bucles:</p>
                            <table border="0" cellspacing="0" cellpadding="4" width="100%" bgcolor="#EAE8A9">

                                <tr>
                                    <td><p class="codigo">
                                        <pre>
bucle:
    PUSH BC         ; Nos queremos guardar BC
    (código que usa B)

    JR flag, bucle
    POP BC
</pre>
                                        </p></td>
                                </tr>
                            </table>

                            <p>En ese código hacemos múltiples PUSHes pero un sólo POP. Probablemente, en realidad,
                                queremos hacer lo siguiente:</p>
                            <table border="0" cellspacing="0" cellpadding="4" width="100%" bgcolor="#EAE8A9">
                                <tr>
                                    <td><p class="codigo">
                                        <pre>
    PUSH BC         ; Nos queremos guardar BC
bucle:
    (código)

    JR flag, bucle
    POP BC

</pre>
                                        </p></td>
                                </tr>
                            </table>

                            <p>Y una curiosidad al respecto de la pila y la sentencia <b>CLEAR</b> de BASIC: en el
                                fondo, lo que realiza esta función es cambiar el valor de la variable del sistema
                                RAMTOP, lo que implica cambiar el valor de SP. Así, con <b>CLEAR XXXX</b>, <em>ponemos
                                    la pila colgando de la dirección de memoria XXXX</em>, asegurándonos de que BASIC no
                                pueda hacer crecer la pila de forma que machaque código máquina que hayamos cargado
                                nosotros en memoria. Si, por ejemplo, vamos a cargar todo nuestro código a partir de
                                50000, en nuestro cargador BASIC haremos un CLEAR 49999, de forma que BASIC no podrá
                                tocar ninguna dirección de memoria por encima de este valor.</p>

                            <p><strong>Rutinas: CALL y RET</strong></p>

                            <p>Ya de por sí el lenguaje ensamblador es un lenguaje de listados largos y enrevesados, y
                                donde teníamos 10 líneas en BASIC podemos tener 100 ó 1000 en ensamblador.</p>
                            <p>Lo normal para hacer el programa más legible es <em>utilizar bloques de código que hagan
                                unas funciones concretas</em> y a los cuales podamos llamar a lo largo de nuestro
                                programa. Esos bloques de código son las <b>funciones o subrutinas</b>.</p>
                            <p>Las subrutinas son bloques de código máquina a las cuales saltamos, hacen su tarea
                                asignada, y devuelven el control al punto en que fueron llamadas. A veces, esperan
                                recibir los registros con una serie de valores y devuelven registros con los valores
                                resultantes.</p>
                            <p>Por ejemplo:</p>
                            <table border="0" cellspacing="0" cellpadding="4" width="100%" bgcolor="#EAE8A9">
                                <tr>
                                    <td><p class="codigo">
                                        <pre>

; SUMA_A_10
;
; SUMA 10 a A y devuelve el resultado en B
;
; Nota: Modifica el valor de A

SUMA_A_10:
   ADD A, 10         ; A = A + 10
   LD B, A           ; B = A
</pre>
                                        </p></td>
                                </tr>
                            </table>

                            <p>Nuestra función/subrutina de ejemplo espera obtener en A un valor, y devuelve el
                                resultado de su ejecución en B. Antes de llamar a esta rutina, nosotros deberemos poner
                                en A el valor sobre el que actuar, y posteriormente interpretar el resultado (sabiendo
                                que lo tenemos en B).</p>
                            <p>Pero, ¿cómo llamamos a las subrutinas y volvemos de ellas? Podéis pensar en nuestro
                                ejemplo anterior y la orden <b>JP</b>:</p>
                            <table border="0" cellspacing="0" cellpadding="4" width="100%" bgcolor="#EAE8A9">
                                <tr>
                                    <td><p class="codigo">
                                        <pre>
    LD A, 35
    JP SUMA_A_10
volver1:

   (...)
SUMA_A_10:
   ADD A, 10         ; A = A + 10
   LD B, A           ; B = A
   JP volver1        ; Volvemos de la subrutina

</pre>
                                        </p></td>
                                </tr>
                            </table>

                            <p>En este caso, cargaríamos A con el valor 35, saltaríamos a la subrutina, sumaríamos 10 a
                                A (pasando a valer 45), haríamos B = 45, y volveríamos al lugar posterior al punto de
                                llamada. Pero ¿qué pasaría si quisieramos volver a llamar a la subrutina desde otro
                                punto de nuestro programa? Que sería inviable, porque nuestra subrutina acaba con un JP
                                volver1 que no devolvería la ejecución al punto desde donde la hemos llamado, sino a
                                volver1.</p>

                            <table border="0" cellspacing="0" cellpadding="4" width="100%" bgcolor="#EAE8A9">
                                <tr>
                                    <td><p class="codigo">
                                        <pre>
    LD A, 35
    JP SUMA_A_10
volver1:

    LD A, 50
    JP SUMA_A_10
                     ; Nunca llegariamos a volver aqui
   (...)
SUMA_A_10:
   ADD A, 10         ; A = A + 10
   LD B, A           ; B = A
   JP volver1        ; Volvemos de la subrutina
</pre>
                                        </p></td>
                                </tr>

                            </table>

                            <p>Para evitar ese enorme problema es para lo que se usa <b>CALL</b> y <b>RET</b>.</p>

                            <p><strong>Uso de CALL y RET</strong></p>
                            <p><b>CALL</b> es, en esencia, similar a JP, salvo porque antes de realizar el salto,
                                introduce en la pila (PUSH) el valor del registro PC (Program Counter, o contador de
                                programa), el cual una vez leído y decodificado el CALL apunta a la siguiente
                                instrucción tras el mismo.</p>
                            <p>¿Y para qué sirve eso? Para que lo aprovechemos dentro de nuestra subrutina con
                                <b>RET</b>. RET lee de la pila la dirección que introdujo CALL y salta a ella. Así,
                                cuando acaba nuestra función, el RET devuelve la ejecución a la instrucción siguiente al
                                CALL que hizo la llamada.</p>

                            <p>Son, por tanto, el equivalente ensamblador de GO SUB y RETURN en BASIC (o más bien se
                                debería decir que GO SUB y RETURN son la implantación en BASIC de estas instrucciones
                                del microprocesador).</p>

                            <table border="0" cellspacing="0" cellpadding="4" width="100%" bgcolor="#EAE8A9">
                                <tr>
                                    <td><p class="codigo">
                                        <pre>
 CALL NN equivale a:
    PUSH PC
    JP NN

 RET equivale a:
    POP PC

<p>Veamos la aplicación de CALL y RET con nuestro ejemplo anterior:</p>

    LD A, 35
    CALL SUMA_A_10

    LD A, 50
    CALL SUMA_A_10

    LD C, B

   (...)

SUMA_A_10:
   ADD A, 10         ; A = A + 10
   LD B, A           ; B = A
   RET               ; Volvemos de la subrutina
</pre>
                                        </p></td>
                                </tr>

                            </table>

                            <p>En esta ocasión, cuando ejecutamos el primer CALL, se introduce en la pila el valor de
                                PC, que se corresponde exáctamente con la dirección de memoria donde estaría ensamblada
                                la siguiente instrucción (LD A, 50). El CALL cambia el valor de PC al de la dirección de
                                SUMA_A_10, y se continúa la ejecución dentro de la subrutina.</p>
                            <p>Al acabar la subrutina encontramos el RET, quien extrae de la pila el valor de PC
                                anteriormente introducido, con lo que en el siguiente ciclo de instrucción del
                                microprocesador, el Z80 leerá, decodificará y ejecutará la instrucción LD A, 50,
                                siguiendo el flujo del programa linealmente desde ahí. Con la segunda llamada a CALL
                                ocurriría lo mismo, pero esta vez lo que se introduce en la pila es la dirección de
                                memoria en la que está ensamblada la instrucción LD C, B. Esto asegura el retorno de
                                nuestra subrutina al punto adecuado.</p>
                            <p>Al hablar de la pila os contamos lo importante que era mantener la misma cantidad de PUSH
                                que de POPs en nuestro código. Ahora entenderéis por qué: si dentro de una subrutina
                                hacéis un PUSH que no elimináis después con un POP, cuando lleguéis al RET éste obtendrá
                                de la pila un valor que no será el introducido por CALL, y saltará allí. Por
                                ejemplo:</p>

                            <table border="0" cellspacing="0" cellpadding="4" width="100%" bgcolor="#EAE8A9">
                                <tr>
                                    <td><p class="codigo">
                                        <pre>
  CALL SUMA_A_10
  LD C, B              ; Esta dirección se introduce en la pila con CALL

SUMA_A_10:
  LD DE, $0000
  PUSH DE
  ADD A, 10
  LD B, a
  RET                  ; RET no sacará de la pila lo introducido por CALL
                       ; sino "0000", el valor que hemos pulsado nosotros.
</pre>
                                        </p></td>
                                </tr>

                            </table>

                            <p>Aquí RET sacará de la pila 0000h, en lugar de la dirección que introdujo CALL, y saltará
                                al inicio del a ROM, produciendo un bonito reset.</p>
                            <p>Ni call ni RET afectan a la tabla de flags del registro F.</p>

                            <table border="0" cellspacing="0" cellpadding="4" width="100%" bgcolor="#EAE8A9">
                                <tr>
                                    <td><p class="codigo">
                                        <pre>
                        Flags
   Instrucción       |S Z H P N C|
 ----------------------------------
 CALL NN             |- - - - - -|
 RET                 |- - - - - -|
</pre>
                                        </p></td>
                                </tr>
                            </table>

                            <p>Saltos y retornos condicionales</p>
                            <p>Una de las peculiaridades de CALL y RET es que tienen instrucciones condicionales con
                                respecto al estado de los flags, igual que JP cc o JR cc, de forma que podemos
                                condicionar el SALTO (CALL) o el retorno (RET) al estado de un determinado flag.</p>
                            <p>Para eso, utilizamos las siguientes instrucciones:</p>
                            <ul>
                                <li><b>CALL flag, NN</b> : Salta sólo si FLAG está activo.</li>
                                <li><b>RET flag</b> : Vuelve sólo si FLAG está activo.</li>

                            </ul>
                            <p>Por ejemplo, supongamos que una de nuestras subrutinas tiene que comprobar que uno de los
                                parámetros que le pasamos, BC, no sea 0.</p>

                            <table border="0" cellspacing="0" cellpadding="4" width="100%" bgcolor="#EAE8A9">
                                <tr>
                                    <td><p class="codigo">
                                        <pre>
; Copia_Pantalla:
;
; Entrada:
;             HL = direccion origen
;             DE = direccion destino
;             BC = bytes a copiar
;
Copia_Pantalla:

   ; lo primero, comprobamos que BC no sea cero:
   LD A, B
   OR C                           ; Hacemos un OR de B sobre C
                                  ; Si BC es cero, activará el flag Z
   RET Z                          ; Si BC es cero, volvemos sin hacer nada

   (más código)
   ; Aquí seguiremos si  BC no es  cero, el
   ; RET no se habrá ejecutado.
</pre>
                                        </p></td>
                                </tr>
                            </table>

                            <p>Del mismo modo, el uso de CALL condicionado al estado de flags (CALL Z, CALL NZ, CALL M,
                                CALL P, etc) nos permitirá llamar o no a funciones según el estado de un flag.</p>
                            <p>Al igual que CALL y RET, sus versiones condicionales no afectan al estado de los
                                flags.</p>

                            <table border="0" cellspacing="0" cellpadding="4" width="100%" bgcolor="#EAE8A9">
                                <tr>
                                    <td><p class="codigo">
                                        <pre>
                        Flags
   Instrucción       |S Z H P N C|         Pseudocodigo
 -----------------------------------------------------------
 CALL cc, NN         |- - - - - -|        IF cc CALL NN
 RET cc              |- - - - - -|        IF cc RET
</pre>
                                        </p></td>
                                </tr>
                            </table>


                            <p><strong>Pasando parametros a rutinas</strong></p>
                            <p>Ahora que ya sabemos crear rutinas y utilizarlas, vamos a ver los 3 métodos que hay para
                                pasar y devolver parámetros a las funciones.</p>

                            <p><em>Método 1: Uso de registros</em></p>
                            <p>Este método consiste en modificar unos registros concretos antes de hacer el CALL a
                                nuestra subrutina, sabiendo que dicha subrutina espera esos registros con los valores
                                sobre los que actuar. Asímismo, nuestra rutina puede modificar alguno de los registros
                                con el objetivo de devolvernos un valor.</p>
                            <p>Por ejemplo:</p>

                            <table border="0" cellspacing="0" cellpadding="4" width="100%" bgcolor="#EAE8A9">
                                <tr>
                                    <td><p class="codigo">
                                        <pre>
; Función de multiplicación de 8 bits
;
; Entrada:
;            H = valor 8 bits
;            E = valor 8 bits
; Salida:
;            HL = valor 16 bits H*E
; Modifica:
;            B, D, L, FLAGS
;
MULTIPLICA:
   LD L, 0
   LD D, L    ; L=0 AND D=0
   LD B, 8
MULT_LOOP:
   ADD HL, HL
   JR NC, NOADD
   ADD HL, DE
NOADD:
   DJNZ MULT_LOOP
</pre>
                                        </p></td>
                                </tr>
                            </table>

                            <p>Antes de hacer la llamada a MULTIPLICA, tendremos que cargar en H y en E los valores que
                                queremos multiplicar, de modo que si estos valores están en otros registros o en
                                memoria, tendremos que moverlos a H y a E.</p>
                            <p>Además, sabemos que la salida nos será devuelta en HL, con lo que si dicho registro
                                (especialmente L en nuestro caso, ya que H es un parámetro de entrada) contiene algún
                                valor importante, deberemos preservarlo previamente.</p>
                            <p>Con este tipo de funciones resulta importantísimo realizarse cabeceras de comentarios
                                explicativos, que indiquen:</p>
                            <ul>
                                <li>a.- Qué función realiza la subrutina.</li>
                                <li>b.- Qué registros espera como entrada.</li>
                                <li>c.- Qué registros devuelve como salida.</li>
                                <li>d.- Qué registros modifica además de los de entrada y salida.</li>

                            </ul>
                            <p>Con este tipo de paso de parámetros tenemos el mayor ahorro y la mayor velocidad: no se
                                accede a la pila y no se accede a la memoria, pero por contra tenemos que tenerlo todo
                                controlado. Tendremos que saber en cada momento qué parámetros de entrada y de salida
                                utiliza (de ahí la importancia del comentario explicativo, al que acudiremos más de una
                                vez cuando no recordemos en qué registros teníamos que pasarle los datos de entrada), y
                                asegurarnos de que ninguno de los registros extra que modifica están en uso antes de
                                llamar a la función, puesto que se verán alterados.</p>
                            <p>Si no queremos que la función modifique muchos registros además de los de entrada y
                                salida, siempre podemos poner una serie de PUSH y POP en su inicio y final, al
                                estilo:</p>

                            <table border="0" cellspacing="0" cellpadding="4" width="100%" bgcolor="#EAE8A9">
                                <tr>
                                    <td><p class="codigo">
                                        <pre>
MiFuncion:
   PUSH BC
   PUSH DE      ; Nos guardamos sus valores

   (...)

   POP DE
   POP BC       ; Recuperamos sus valores
   RET
</pre>
                                        </p></td>
                                </tr>
                            </table>

                            <p>En funciones que no sean críticas en velocidad, es una buena opción porque no tendremos
                                que preocuparnos por el estado de nuestros registros durante la ejecución de la
                                subrutina: al volver de ella tendrán sus valores originales (excepto aquellos de entrada
                                y salida que consideremos necesarios).</p>

                            <p>No nos olvidemos de que en algunos casos podemos usar el juego de registros alternativos
                                (EX AF, AF', EXX) para evitar algún PUSH o POP.</p>

                            <p><em>Método 2: Uso de localidades de memoria</em></p>
                            <p>Aunque no es una opción rápida, sí que es bastante efectivo y sencillo el uso de
                                variables o posiciones de memoria para pasar y recoger parámetros de funciones. Nos
                                ahorra el uso de muchos registros, y hace que podamos usar dentro de las funciones
                                prácticamente todos los registros. Se hace especialmente útil usando el juego de
                                registros alternativos.</p>
                            <p>Por ejemplo:</p>

                            <table border="0" cellspacing="0" cellpadding="4" width="100%" bgcolor="#EAE8A9">
                                <tr>
                                    <td><p class="codigo">
                                        <pre>
      LD A, 10
      LD (x), A
      LD A, 20
      LD (y), A
      LD BC, 40
      LD (size), BC      ; Parametros de entrada a la funcion
      CALL MiFuncion
      (...)

MiFuncion:
      EXX                ; Preservamos TODOS los registros

      LD A, (x)
      LD B, A
      LD A, (y)
      LD BC, (size)      ; Leemos los parametros

      (Codigo)

      LD (salida), a     ; Devolvemos un valor
      EXX

x      DB  0
y      DB  0
size   DW  0
salida DB  0
</pre>

                                        </p></td>
                                </tr>
                            </table>

                            <p>Este es un ejemplo exagerado donde todos los parámetros se pasan en variables, pero lo
                                normal es usar un método mixto entre este y el anterior, pasando cosas en registros
                                excepto si nos quedamos sin ellos (por que una función requiere muchos parámetros, por
                                ejemplo), de forma que algunas cosas las pasamos con variables de memoria.</p>

                            <p><em>Método 3: Uso de la pila (método C)</em></p>
                            <p>El tercer método es el sistema que utilizan los lenguajes de alto nivel para pasar
                                parámetros a las funciones: el apilamiento de los mismos. Este sistema no se suele
                                utilizar en ensamblador, pero vamos a comentarlo de forma que os permita integrar
                                funciones en ASM dentro de programas escritos en C, como los compilables con el
                                ensamblador Z88DK.</p>
                            <p>En C (y en otros lenguajes de programación) los parámetros se insertan en la pila en el
                                orden en que son leídos. La subrutina debe utilizar el registro SP (una copia) para
                                acceder a los valores apilados en orden inverso. Estos valores son siempre de 16 bits
                                aunque las variables pasadas sean de 8 bits (en este caso ignoraremos el byte que no
                                contiene datos, el segundo).</p>
                            <p>Veamos unos ejemplos:</p>

                            <table border="0" cellspacing="0" cellpadding="4" width="100%" bgcolor="#EAE8A9">

                                <tr>
                                    <td><p class="codigo">
                                        <pre>
//-----------------------------------------------------------------
// Sea parte de nuestro programa en C:

  int jugador_x, jugador_y;

  jugador_x = 10;
  jugador_y = 200;
  Funcion( jugador_x, jugador_y );
  (...)



//-----------------------------------------------------------------
int Funcion( int x, int y )
{

#asm
   LD HL,2
   ADD HL,SP           ; Ahora SP apunta al ultimo parametro metido
                       ; en la pila por el compilador (valor de Y)

   LD C, (HL)
   INC HL
   LD B, (HL)
   INC HL              ; Ahora BC = y

   LD E, (HL)
   INC HL
   LD D, (HL)
   INC HL              ; Ahora, DE = x

   (ahora hacemos lo que queramos en asm)

#endasm
}
</pre>
                                        </p></td>
                                </tr>
                            </table>

                            <p>No tenemos que preocuparnos por hacer PUSH y POP de los registros para preservar su valor
                                dado que C lo hace automáticamente antes y después de cada #asm y #endasm.</p>
                            <p>El problema es que conforme crece el número de parámetros apilados, es posible que
                                tengamos que hacer malabarismos para almacenarlos, dado que no podemos usar HL (es
                                nuestro puntero a la pila en las lecturas). Veamos el siguiente ejemplo con 3
                                parámetros, donde tenemos que usar PUSH para guardar el valor de DE y EX DE, HL para
                                acabar asociando el valor final a HL:</p>

                            <table border="0" cellspacing="0" cellpadding="4" width="100%" bgcolor="#EAE8A9">
                                <tr>
                                    <td><p class="codigo">

                                        <pre>
//-----------------------------------------------------------------
int Funcion( int x, int y, int z )
{

#asm
   LD HL,2
   ADD HL,SP           ; Ahora SP apunta al ultimo parametro metido
                       ; en la pila por el compilador (tamanyo)

   LD C, (HL)
   INC HL
   LD B, (HL)
   INC HL              ; Ahora BC = z

   LD E, (HL)
   INC HL
   LD D, (HL)
   INC HL              ; Ahora, DE = y

   PUSH DE             ; Guardamos DE

   LD E, (HL)
   INC HL
   LD D, (HL)
   INC HL              ; Usamos DE para leer el valor de x

   EX DE, HL           ; Ahora cambiamos x a HL
   POP DE              ; Y recuperamos el valor de y en DE

   ; (ahora hacemos lo que queramos en asm)

#endasm
}
</pre>
                                        </p></td>
                                </tr>
                            </table>

                            <p>La manera de leer bytes (char) pulsados en C es de la misma forma que leemos una palabra
                                de 16 bits, pero ignorando la parte alta. En realidad, como la pila es de 16 bits, el
                                compilador convierte el dato de 8 bits en uno de 16 (rellenando con ceros) y pulsa este
                                valor:</p>

                            <table border="0" cellspacing="0" cellpadding="4" width="100%" bgcolor="#EAE8A9">
                                <tr>
                                    <td><p class="codigo">
                                        <pre>
//-----------------------------------------------------------------
int Funcion( char x, y )
{

#asm
   LD HL,2
   ADD HL,SP           ; Ahora SP apunta al ultimo parametro metido
                       ; en la pila por el compilador (tamanyo)

   LD A, (HL)          ; Aquí tenemos nuestro dato de 8 bits (y)
   LD B, A
   INC HL
   INC HL              ; La parte alta del byte no nos interesa

   LD A, (HL)          ; Aquí tenemos nuestro dato de 8 bits (x)
   LD C, A
   INC HL
   INC HL              ; La parte alta del byte no nos interesa

   (ahora hacemos lo que queramos en asm)

#endasm
}
</pre>
                                        </p></td>
                                </tr>

                            </table>

                            <p>En ocasiones, es posible que incluso tengamos que utilizar variables auxiliares de
                                memoria para guardar datos:</p>

                            <table border="0" cellspacing="0" cellpadding="4" width="100%" bgcolor="#EAE8A9">
                                <tr>
                                    <td><p class="codigo">
                                        <pre>
//-----------------------------------------------------------------
int Funcion( int x, int y, char z )
{

#asm
   LD HL,2
   ADD HL,SP           ; Ahora SP apunta al ultimo parametro metido
                       ; en la pila por el compilador (tamanyo)

   LD C, (HL)
   INC HL
   LD B, (HL)
   INC HL              ; Ahora BC = y
   LD (valor_y), BC    ; nos lo guardamos, BC libre de nuevo

   LD C, (HL)
   INC HL
   LD B, (HL)
   INC HL
   LD (valor_x), BC    ; Nos lo guardamos, BC libre de nuevo

   LD A, (HL)
   LD (valor_z), A     ; Nos guardamos el byte
   INC HL
   INC HL              ; La parte alta del byte no nos interesa

   (ahora hacemos lo que queramos en asm)

   RET

valor_x  defw  0
valor_y  defw  0
valor_z  defb  0

#endasm
}
</pre>
                                        </p></td>
                                </tr>
                            </table>

                            <p>Por contra, para devolver valores no se utiliza la pila (dado que no podemos tocarla),
                                sino que se utiliza un determinado registro. En el caso de Z88DK, se utiliza el registro
                                HL. Si la función es de tipo INT o CHAR en cuanto a devolución, el valor que dejemos en
                                HL será el que se asignará en una llamada de este tipo:</p>

                            <table border="0" cellspacing="0" cellpadding="4" width="100%" bgcolor="#EAE8A9">
                                <tr>
                                    <td><p class="codigo">
                                        <pre>
 valor = MiFuncion_ASM( x, y, z);
</pre>
                                        </p></td>
                                </tr>
                            </table>

                            <p>Hemos considerado importante explicar este tipo de paso de parámetros y devolución de
                                valores porque nos permite integrar nuestro código ASM en programas en C.</p>

                            <p><strong>Integracion de ASM en Z88DK</strong></p>

                            <p>Para aprovechar esta introducción de uso de ASM en z88dk, veamos el código de alguna
                                función en C que use ASM internamente y que muestre, entre otras cosas, la lectura de
                                parámetros de la pila, el acceso a variables del código C, el uso de etiquetas, o la
                                devolución de valores.</p>

                            <table border="0" cellspacing="0" cellpadding="4" width="100%" bgcolor="#EAE8A9">
                                <tr>
                                    <td><p class="codigo">
                                        <pre>
//
// Devuelve la direccion de memoria del atributo de un caracter
// de pantalla, de coordenadas (x,y). Usando la dirección que
// devuelve esta función (en HL, devuelto en la llamada), podemos
// leer o cambiar los atributos de dicho carácter.
//
// Llamada:   valor =  Get_LOWRES_Attrib_Address( 1, 3 );
//
int Get_LOWRES_Attrib_Address( char x, char y )
{
#asm

   LD HL, 2
   ADD HL, SP                 ; Leemos x e y de la pila
   LD  D, (HL)  ; d = y
   INC HL                     ; Primero "y" y luego "x".
   INC HL                     ; Como son "char", ignoramos parte alta.
   LD  E, (HL)  ; e = x

   LD H, 0
   LD L, D
   ADD HL, HL                 ; HL = HL*2
   ADD HL, HL                 ; HL = HL*4
   ADD HL, HL                 ; HL = HL*8
   ADD HL, HL                 ; HL = HL*16
   ADD HL, HL                 ; HL = HL*32
   LD D, 0
   ADD HL, DE                 ; Ahora HL = (32*y)+x
   LD BC, 16384+6144          ; Ahora BC = offset attrib (0,0)
   ADD HL, BC                 ; Sumamos y devolvemos en HL

#endasm
}

//
// Set Border
// Ejemplo de modificación del borde, muestra cómo leer variables
// globales de C en ASM, añadiendo "_" delante.
//

char my_tmp_border;

void BORDER( unsigned char value )
{
   my_tmp_border = value<<3;
#asm
   LD HL, 2
   ADD HL, SP
   LD A, (HL)
   LD C, 254
   OUT (C), A
   LD HL, 23624
   LD A, (_my_tmp_border)
   LD (HL), A
#endasm
}


//
// Realización de un fundido de la pantalla hacia negro
// Con esta función se muestra el uso de etiquetas. Nótese
// como en lugar de escribirse como ":", se escriben sin
// ellos y con un punto "." delante.
//
void FadeScreen( void )
{

#asm

   LD B, 16

.fadescreen_loop1
   LD HL, 16384+6144
   LD DE, 768

.fadescreen_loop2
   LD A, (HL)                  ; get attr

   LD C, A
   AND 7                       ; get last  bits
   JR Z, fadescreen_ink_zero   ; if its zero, not dec it

   DEC A
   EX AF, AF

.fadescreen_ink_zero
   LD A, C
   AND 7
   SRA A
   SRA A
   SRA A
   JR Z, fadescreen_paper_zero   ; if its zero, not dec it

   DEC A

.fadescreen_paper_zero
   SLA A
   SLA A
   SLA A
   LD C, A
   EX AF, AF
   ADD A, C

   LD (HL), A
   INC HL

   DEC DE                       ; internal loop
   LD A, D
   OR E
   JP NZ, fadescreen_loop2

   DJNZ fadescreen_loop1

#endasm
}
</pre>
                                        </p></td>
                                </tr>
                            </table>

                            <p>Si tenéis curiosidad por ver el funcionamiento de esta rutina de Fade (fundido), podéis
                                verla integramente en ASM en el fichero fade.asm. Un detalle a tener en cuenta, en Z88DK
                                se soporta EX AF, AF, mientras que pasmo requiere poner la comilla del
                                shadow-register: EX AF, AF'.</p>


                            <table border="0" cellspacing="0" cellpadding="2" width="320">
                                <tr align="right">
                                    <td><img src="img/fade.png" width="320" height="240"
                                             alt="Captura durante el fade de la pantalla"/>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="piefoto" align="right">Captura durante el fade de la pantalla</td>
                                </tr>
                            </table>


                            <p>En la anterior captura podéis ver el aspecto de uno de los pasos del fundido.</p>

                            <p><strong>La importancia de usar subrutinas</strong></p>
                            <p>Usar subrutinas es mucho más importante de lo que parece a simple vista: <em>nos permite
                                organizar el programa en unidades o módulos funcionales</em> que cumplen una serie de
                                funciones específicas, lo que hace mucha más sencilla su depuración y optimización.</p>
                            <p>Si en el menú de nuestro juego estamos dibujando una serie de sprites móviles, y también
                                lo hacemos a lo largo del juego, resulta absurdo construir 2 bloques de código, uno
                                para mover los sprites del menú y otro para los del juego. Haciendo esto, si encontramos
                                un error en una de las 2 rutinas, o realizamos una mejora, deberemos corregirlo en
                                ambas.</p>
                            <p>Por contra, si creamos una subrutina, digamos, DrawSprite, que podamos llamar con los
                                parámetros adecuados en ambos puntos del programa, cualquier cambio, mejora o corrección
                                que realicemos en DrawSprite afectará a todas las llamadas que le hagamos. También
                                reducimos así el tamaño de nuestro programa (y con él el tiempo de carga del mismo), las
                                posibilidades de fallo, y la longitud del listado (haciéndolo más legible y
                                manejable).</p>
                            <p>Aunque no sea el objetivo de esta serie de artículos, antes de sentarse a teclear, un
                                buen programador debería coger un par de folios de papel y hacer un pequeño análisis de
                                lo que pretende crear. Este proceso, la fase de diseño, define qué debe de hacer el
                                programa y, sobre todo, una división lógica de cuáles son las principales partes del
                                mismo. Un sencillo esquema en papel, un diagrama de flujo, identificar las diferentes
                                partes del programa, etc.</p>

                            <p>El proceso empieza con un esbozo muy general del programa, que será coincidente con la
                                gran mayoría de los juegos: inicialización de variables, menú (que te puede llevar bien
                                a las opciones o bien al juego en sí), y dentro del juego, lectura de teclado/joystick,
                                trazado de la pantalla, lógica del juego, etc.</p>
                            <p>Después, se teclea un programa vacío que siga esos pasos, pero que no haga nada; un bucle
                                principal que tenga un aspecto parecido a:</p>

                            <table border="0" cellspacing="0" cellpadding="4" width="100%" bgcolor="#EAE8A9">
                                <tr>
                                    <td><p class="codigo">
                                        <pre>
BuclePrincipal:
     CALL Leer_Teclado
     CALL Logica_Juego
     CALL Comprobar_Estado
     jp Bucle_Principal

Leer_Teclado:
     RET

Logica_Juego:
     RET

Comprobar_Estado:
     RET
</pre>
                                        </p></td>
                                </tr>
                            </table>

                            <p>Tras esto, ya tenemos el esqueleto del programa. Y ahora hay que rellenar ese
                                esqueleto, y la mejor forma de hacerlo es aprovechar esa modularidad que hemos
                                obtenido con ese diseño en papel.</p>

                            <p>Por ejemplo, supongamos que nuestro juego tiene que poder dibujar sprites y pantallas
                                hechas a bases de bloques que se repiten (tiles). Gracias a nuestro diseño, sabemos que
                                necesitamos una rutina que imprima un sprite, una rutina que dibuje un tile y una rutina
                                que dibuje una pantalla llena de tiles.</p>
                            <p>Pues bien, creamos un programa en ASM nuevo, desde cero, y en él creamos una función
                                DrawSprite que acepte como parámetros la dirección origen de los datos del Sprite, y las
                                posiciones X e Y donde dibujarlo, y la realizamos. En este nuevo programa, pequeño,
                                sencillo de leer, realizamos todo tipo de pruebas:</p>

                            <table border="0" cellspacing="0" cellpadding="4" width="100%" bgcolor="#EAE8A9">
                                <tr>
                                    <td><p class="codigo">
                                        <pre>
   ORG 50000

   ; Probamos de diferentes formas nuestra rutina
   LD B, 10
   LD C, 15
   LD HL, sprite
   CALL DrawSprite
   RET

; Rutina DrawSprite
; Acepta como parametros ... y devuelve ...
DrawSprite:
   (aquí el código)
   RET

sprite DB 0,0,255,123,121,123,34, (etc...)
</pre>
                                        </p></td>
                                </tr>
                            </table>

                            <p>Gracias a esto, podremos probar nuestra nueva rutina y trabajar con ella limpiamente y en
                                un fichero de programa pequeño. Cuando la tenemos lista, basta con copiarla a nuestro
                                programa principal y ya sabemos que la tenemos disponible para su uso con CALL.</p>

                            <p>Así, vamos creando diferentes rutinas en un entorno controlado y testeable, y las vamos
                                incorporando a nuestro programa. Si hay algún bug en una rutina y tenemos que
                                reproducirlo, podemos hacerlo en nuestros pequeños programas de prueba, evitando el
                                típico problema de tener que llegar a un determinado punto de nuestro programa para
                                chequear una rutina, o modificar su bucle principal para hacerlo.</p>
                            <p>Además, el definir de antemano qué tipo de subrutinas necesitamos y qué parámetros deben
                                aceptar o devolver permite trabajar en equipo. Si sabes que necesitarás una rutina que
                                dibuje un sprite, o que lea el teclado y devuelva la tecla pulsada, puedes decir los
                                registros de entrada y los valores de salida que necesitas, y que la realice una segunda
                                persona y te envíe la rutina lista para usar.</p>
                            <p>En ocasiones una excesiva desgranación del programa en módulos más pequeños puede dar
                                lugar a una penalización en el rendimiento, aunque no siempre es así. Por ejemplo,
                                supongamos que tenemos que dibujar un mapeado de 10×10 bloques de 8×8 pixeles cada uno.
                                Si hacemos una función de que dibuja un bloque de 8×8, podemos llamarla en un bucle para
                                dibujar nuestros 10×10 bloques.</p>
                            <p>Hay gente que, en lugar de esto, preferirá realizar una función específica que dibuje los
                                10×10 bloques dentro de una misma función. Esto es así porque de este modo te evitas 100
                                CALLs (10×10) y sus correspondientes RETs, lo cual puede ser importante en una rutina
                                gráfica que se ejecute X veces por segundo. Por supuesto, en muchos casos tendrán razón,
                                en ciertas ocasiones hay que hacer rutinas concretas para tareas concretas, aún cuando
                                puedan repetir parte de otro código que hayamos escrito anteriormente, con el objetivo
                                de evitar llamadas, des/apilamientos u operaciones innecesarias en una función
                                crítica.</p>
                            <p>Pero si, por ejemplo, nosotros sólo dibujamos la pantalla una vez cuando nuestro
                                personaje sale por el borde, y no volvemos a dibujar otra hasta que sale por otro borde
                                (típico caso de juegos sin scroll que muestran pantallas completas de una sóla vez),
                                vale la pena el usar funciones modulares dado que unos milisegundos más de ejecución en
                                el trazado de la pantalla no afectarán al desarrollo del juego.</p>
                            <p>Al final hay que llegar a un compromiso entre modularidad y optimización, en algunos
                                casos nos interesará desgranar mucho el código, y en otros nos interesará hacer
                                funciones específicas. Y esa decisión no deja de ser, al fin y al cabo, diseño del
                                programa.</p>
                            <p>En cualquier caso, el diseño nos asegura que podremos implementar nuestro programa en
                                cualquier lenguaje y en cualquier momento. Podremos retomar nuestros papeles de diseño
                                3 meses después y, pese a no recordar en qué parte del programa estábamos, volver a su
                                desarrollo sin excesivas dificultades.</p>
                            <p>Una de las cosas más complicadas de hacer un juego es el pensar por dónde empezar. Todo
                                este proceso nos permite empezar el programa por la parte del mismo que realmente
                                importa. Todos hemos empezado alguna vez a realizar nuestro juego por el menú, perdiendo
                                muchas horas de trabajo para descubrir que teníamos un menú, pero no teníamos un juego,
                                y que ya estábamos cansados del desarrollo sin apenas haber empezado.</p>
                            <p>Veamos un ejemplo: suponiendo que realizamos, por ejemplo, un juego de puzzles tipo
                                Tetris, lo ideal sería empezar definiendo dónde se almacenan los datos del area de
                                juego, hacer una función que convierta esos datos en imágenes en pantalla, y realizar un
                                bucle que permita ver caer la pieza. Después, se agrega control por teclado para la
                                pieza y se pone la lógica del juego (realización de líneas al tocar suelo, etc).</p>

                            <p>Tras esto, ya tenemos el esqueleto funcional del juego y podemos añadir opciones, menúes
                                y demás. Tendremos algo tangible, funcional, donde podemos hacer cambios que implican un
                                inmediato resultado en pantalla, y no habremos malgastado muchas horas con un simple
                                menú.</p>
                            <p>Por otra parte, el diseñar correctamente nuestro programa y desgranarlo en piezas
                                reutilizables redundará en nuestro beneficio no sólo actual (con respecto al programa
                                que estamos escribiendo) sino futuro, ya que podremos crearnos nuestras propias
                                bibliotecas de funciones que reutilizar en futuros programas. Aquella rutina de
                                dibujado de Sprites, de zoom de pantalla o de compresión de datos que tanto nos costó
                                programar, bien aislada en una subrutina y con sus parámetros de entrada y salida bien
                                definidos puede ser utilizada directamente en nuestros próximos programas simplemente
                                copiando y pegando el código correspondiente.</p>
                            <p>Más aún, podemos organizar funciones con finalidades comunes en ficheros individuales.
                                Tendremos así nuestro fichero / biblioteca con funciones gráficas, de sonido, de
                                teclado/joystick, etc. El ensamblador PASMO nos permite incluir un fichero en cualquier
                                parte de nuestro código con la directiva <b>INCLUDE</b>.</p>
                            <p>Así, nuestro programa en ASM podría comenzar (o acabar) por algo como:</p>

                            <table border="0" cellspacing="0" cellpadding="4" width="100%" bgcolor="#EAE8A9">
                                <tr>
                                    <td><p class="codigo">
                                        <pre>
INCLUDE "graficos.asm"
INCLUDE "sonido.asm"
INCLUDE "teclado.asm"
INCLUDE "datos.asm"
</pre>

                                        </p></td>
                                </tr>
                            </table>

                            <p>Esto contribuye a reducir fallos en la codificación, hacer más corto el listado general
                                del programa, y, sobre todo, reduce el tiempo de desarrollo.</p>


                            <p align="center"><font size="5">Lenguaje Ensamblador del Z80 (V)</font></p>
                            <p><b> Puertos de E/S y Tabla de Opcodes </b></p>


                            <p>En este capítulo se introducirán las instrucciones <b>IN</b> y <b>OUT</b> para la
                                exploración
                                de los puertos del microprocesador, mostrando cómo el acceso a dichos puertos nos
                                permitirá la gestión de los diferentes dispositivos conectados al microprocesador
                                (teclado, altavoz, controladora de disco, etc...).</p>

                            <p>Finalmente, para acabar con la descripción del juego de instrucciones del Z80
                                veremos algunos ejemplos de <em>opcodes no documentados</em>, y una
                                <em>tabla-resumen</em> con
                                la mayoría de instrucciones, así como sus tiempos de ejecución y tamaños.</p>


                            <p><b> Los puertos E/S </b></p>


                            <p>Como ya vimos en su momento, el microprocesador Z80 se conecta
                                mediante los puertos de entrada/salida de la CPU a los periféricos
                                externos (teclado, cassette y altavoz de audio), pudiendo leer el
                                estado de los mismos (leer del teclado, leer del cassette) y escribir
                                en ellos (escribir en el altavoz para reproducir sonido, escribir en
                                el cassette) por medio de estas conexiones conocidas como "<em>I/O Ports</em>".</p>


                            <table border="0" cellspacing="0" cellpadding="2" width="500">
                                <tr align="right">
                                    <td><img src="img/esquema_zx.gif" width="500" height="400"
                                             alt="Esquema de hardware de un ZX Spectrum"/>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="piefoto" align="right">Esquema de hardware de un ZX Spectrum</td>
                                </tr>

                            </table>


                            Aunque para nosotros el teclado o el altavoz puedan ser parte del
                            ordenador, para el Z80, el microprocesador en sí mismo, son tan
                            externos a él como el monitor o el joystick. Nuestro microprocesador
                            accede a todos estos elementos externos mediante una serie de patillas
                            (buses de datos y direcciones) que son conectadas eléctricamente a
                            todos los elementos externos con los que queremos que interactúe. La
                            memoria, el teclado, el altavoz, o los mismos pines del bus trasero
                            del Spectrum, se conectan al Z80 y éste nos permite su acceso a través
                            de dichas líneas, o de los puertos de entrada/salida (I/O).</p>


                            <p><b> IN y OUT </b></p>

                            <p>Ya conocemos la existencia y significado de los puertos y su conexión
                                con el microprocesador. Sólo resta saber: ¿cómo accedemos a un puerto
                                tanto para leer como para escribir desde nuestros programas en
                                ensamblador?</p>

                            <p>La respuesta la tienen los comandos <b>IN</b> y <b>OUT</b> del Z80.</p>

                            <p>Comenzaremos con <b>IN</b>, que nos permite leer el valor de un puerto ya
                                sea directamente, o cargado sobre el registro BC:</p>

                            <p><b>IN registro, (C)</b></p>
                            <p>Leemos el puerto "BC" y ponemos su contenido en el registro especificado.</p>
                            En realidad, pese a que teóricamente el Spectrum sólo tiene acceso a puertos
                            E/S de 8 bits (0-255), para acceder a los puertos, IN r, (C) pone todo el valor
                            de BC en el bus de direcciones.</p>

                            <p><b>IN A, (puerto)</b></p>
                            <p>Leemos el puerto "A*256 + Puerto" y ponemos su contenido en A. En esta
                                ocasión, el Spectrum pone en el bus de direcciones el valor del registro
                                de 16 bits formado por A y (puerto) (en lugar de BC).</p>

                            <p>Por ejemplo, estas 2 lecturas de puerto (usando los 2 formatos de la
                                instrucción IN vistos anteriormente) son equivalentes:</p>

                            <table border="0" cellspacing="0" cellpadding="4" width="100%" bgcolor="#EAE8A9">
                                <tr>
                                    <td><p class="codigo">
                                        <pre>
; Forma 1
LD BC, FFFEh
IN A, (C)       ; A = Lectura de puerto FFFEh

; Forma 2
LD A, FFh
IN A, (FEh)     ; A = Lectura de puerto FFFEh

</pre>
                                        </p></td>
                                </tr>
                            </table>

                            <p>Aunque la instrucción de la "Forma 1" hable del puerto C, en realidad
                                el puerto es un valor de 16 bits y se carga en el registro BC.</p>

                            <p>De la misma forma, podemos escribir un valor en un puerto con sus equivalentes "OUT":</p>

                            <p><b>OUT (puerto), A </b></p>
                            <p>Escribimos en "puerto" (valor de 8 bits) el valor de A.</p>

                            <p><b>OUT (C), registro</b></p>
                            <p>Escribimos en el puerto "C" el valor contenido en "registro" (aunque se pone el
                                valor de BC en el bus de direcciones).</p>

                            <p>Curiosamente, como se explica en el excelente documento "//The
                                Undocumented Z80 Documented//" (que habla de las funcionalidades y
                                opcodes no documentados del Z80), los puertos del Spectrum son
                                oficialmente de 8 bits (0-255) aunque realmente se pone o bien BC o
                                bien (A*256)+PUERTO en el bus de direcciones, por lo que en el fondo
                                se pueden acceder a todos los 65536 puertos disponibles.</p>

                            <p>La forma en que estas instrucciones afectan a los flags es la siguiente:</p>

                            <table border="0" cellspacing="0" cellpadding="4" width="100%" bgcolor="#EAE8A9">
                                <tr>
                                    <td><p class="codigo">
                                        <pre>
                        Flags
  Instrucción       |S Z H P N C|
----------------------------------
  IN A, (n)         |- - - - - -|
  IN r, (C)         |* * * P 0 -|
  OUT (C), r        |- - - - - -|
  OUT (n), A        |- - - - - -|
</pre>
                                        </p></td>
                                </tr>
                            </table>

                            <p>Aunque entre los 2 formatos OUT no debería haber ninguna diferencia funcional, cabe
                                destacar que "OUT (N), A" es 1 t-estado o ciclo de reloj más rápida que "OUT (C), A",
                                tardando 11 y 12 t-estados respectivamente.</p>


                            <p><b> Instrucciones de puerto repetitivas e incrementales </b></p>


                            <p>Al igual que LD carga un valor de un origen a un destino, y tiene sus correspondientes
                                instrucciones incrementales (LDI "carga e incrementa", LDD "carga y decrementa") o
                                repetitivas (LDIR "carga, incrementa y repite BC veces", LDDR "carga, decrementa, y
                                repite BC veces"), IN y OUT tienen sus equivalentes incrementales y repetidores.</p>

                            <p>Así:</p>

                            <ul>
                                <li><b>IND</b> :</li>
                                <ul>

                                    <li>Leemos en la dirección de memoria apuntada por HL ([HL]) el valor contenido en
                                        el puerto C.
                                    </li>
                                    <li>Decrementamos HL.</li>
                                    <li>Decrementamos B.</li>
                                </ul>
                                <li><b>INI</b> :</li>
                                <ul>
                                    <li>Leemos en la dirección de memoria apuntada por HL ([HL]) el valor contenido en
                                        el puerto C.
                                    </li>
                                    <li>Incrementamos HL.</li>
                                    <li>Decrementamos B.</li>

                                </ul>
                                <li><b>OUTD</b> :</li>
                                <ul>
                                    <li>Escribimos en el puerto C el valor de la dirección de memoria apuntada por HL
                                        ([HL]).
                                    </li>
                                    <li>Decrementamos HL.</li>
                                    <li>Decrementamos B.</li>
                                </ul>
                                <li><b>OUTI</b> :</li>

                                <ul>
                                    <li>Escribimos en el puerto C el valor de la dirección de memoria apuntada por HL
                                        ([HL]).
                                    </li>
                                    <li>Incrementamos HL.</li>
                                    <li>Decrementamos B.</li>
                                </ul>
                            </ul>

                            <p>Y sus versiones repetitivas <b>INDR, INIR, OTDR</b> y <b>OTIR</b>, que realizan la misma
                                función que sus hermanas incrementales, repitiéndolo hasta que BC sea cero.</p>

                            <p>Las afectaciones de flags de estas funciones son las siguientes:</p>

                            Flags:</p>

                            <table border="0" cellspacing="0" cellpadding="4" width="100%" bgcolor="#EAE8A9">
                                <tr>
                                    <td><p class="codigo">
                                        <pre>
                        Flags
  Instrucción       |S Z H P N C|
----------------------------------
  INI               |? * ? ? 1 ?|
  IND               |? * ? ? 1 ?|
  OUTI              |? * ? ? 1 ?|
  OUTD              |? * ? ? 1 ?|
  INDR              |? 1 ? ? 1 ?|
  INIR              |? 1 ? ? 1 ?|
  OTDR              |? 1 ? ? 1 ?|
  OTIR              |? 1 ? ? 1 ?|
</pre>
                                        </p></td>
                                </tr>
                            </table>

                            Nota: Pese a que la documentación oficial dice que estas instrucciones no
                            afectan al Carry Flag, las pruebas hechas a posteriori y recopiladas en
                            la información disponible sobre Opcodes No Documentados del Z80 sugieren que
                            sí que son modificados.</p>


                            <p><b> Algunos puertos E/S comunes </b></p>


                            <p>Para terminar con el tema de los puertos de Entrada y Salida, vamos a hacer
                                referencia a algunos puertos disponibles en el Sinclair Spectrum (algunos de
                                ellos sólo en ciertos modelos).</p>

                            <p>Como veremos en capítulo dedicado al teclado, existe una serie de puertos
                                E/S que acceden directamente a la lectura del estado de las diferentes teclas
                                de nuestro Spectrum. Leyendo del puerto adecuado, y chequeando en la respuesta
                                obtenida el bit concreto asociado a la tecla que queremos consultar podremos
                                conocer si una determinada tecla está pulsada (0) o no pulsada (1), como
                                podemos ver en el siguiente ejemplo:</p>

                            <table border="0" cellspacing="0" cellpadding="4" width="100%" bgcolor="#EAE8A9">

                                <tr>
                                    <td><p class="codigo">
                                        <pre>
 ; Lectura de la tecla "P" en un bucle
 ORG 50000

bucle:
 LD BC, $DFFE         ; Semifila "P" a "Y"
 IN A, (C)            ; Leemos el puerto
 BIT 0, A             ; Testeamos el bit 0
 JR Z, salir          ; Si esta a 0 (pulsado) salir.
 JR bucle             ; Si no (a 1, no pulsado) repetimos

salir:
 RET
</pre>
                                        </p></td>
                                </tr>
                            </table>

                            <p>El anterior ejemplo lee constantemente el puerto $DFFE a la espera de
                                que el bit 0 de la respuesta obtenida de dicha lectura sea 0, lo que quiere
                                decir que la tecla "p" ha sido pulsada.</p>

                            <p>Aunque los veremos en su momento en profundidad, estos son los puertos
                                asociados a las diferentes filas de teclas:</p>

                            <table class="flags">

                                <tr>
                                    <th>Puerto</th>
                                    <th>Bits:</th>
                                    <th>D4</th>
                                    <th>D3</th>
                                    <th>D2</th>
                                    <th>D1</th>
                                    <th>D0</th>
                                </tr>
                                <tr>
                                    <td>65278d (FEFEh)</td>
                                    <td>Teclas:</td>
                                    <td>"V"</td>
                                    <td>"C"</td>
                                    <td>"X"</td>
                                    <td>"Z"</td>
                                    <td>CAPS</td>
                                </tr>
                                <tr>
                                    <td>65022d (FDFEh)</td>
                                    <td>Teclas:</td>
                                    <td>"G"</td>
                                    <td>"F"</td>
                                    <td>"D"</td>
                                    <td>"S"</td>
                                    <td>"A"</td>
                                </tr>

                                <tr>
                                    <td>64510d (FBFEh)</td>
                                    <td>Teclas:</td>
                                    <td>"T"</td>
                                    <td>"R"</td>
                                    <td>"E"</td>
                                    <td>"W"</td>
                                    <td>"Q"</td>
                                </tr>
                                <tr>
                                    <td>63486d (F7FEh)</td>
                                    <td>Teclas:</td>
                                    <td>"5"</td>
                                    <td>"4"</td>
                                    <td>"3"</td>
                                    <td>"2"</td>
                                    <td>"1"</td>
                                </tr>
                                <tr>
                                    <td>61438d (EFFEh)</td>
                                    <td>Teclas:</td>
                                    <td>"0"</td>
                                    <td>"9"</td>
                                    <td>"8"</td>
                                    <td>"7"</td>
                                    <td>"6"</td>
                                </tr>

                                <tr>
                                    <td>57342d (DFFEh)</td>
                                    <td>Teclas:</td>
                                    <td>"Y"</td>
                                    <td>"U"</td>
                                    <td>"I"</td>
                                    <td>"O"</td>
                                    <td>"P"</td>
                                </tr>
                                <tr>
                                    <td>49150d (BFFEh)</td>
                                    <td>Teclas:</td>
                                    <td>"H"</td>
                                    <td>"J"</td>
                                    <td>"K"</td>
                                    <td>"L"</td>
                                    <td>ENTER</td>
                                </tr>
                                <tr>
                                    <td>32766d (7FFEh)</td>
                                    <td>Teclas:</td>
                                    <td>"B"</td>
                                    <td>"N"</td>
                                    <td>"M"</td>
                                    <td>SYMB</td>
                                    <td>SPACE</td>
                                </tr>

                            </table>

                            <p>El bit 6 de los puertos que hemos visto para el teclado tiene un valor
                                aleatorio, excepto cuando se pulsa PLAY en el cassette, y es a través
                                de dicho bit de donde podremos obtener los datos a cargar.</p>

                            <p>La escritura en el puerto 00FEh permite <em>acceder al altavoz</em> (bit 4)
                                y a la señal de audio para grabar a cinta (bit 3). Los bits 0, 1 y 2
                                controlan <em>el color del borde</em>, como podemos ver en el siguiente ejemplo:</p>


                            <table border="0" cellspacing="0" cellpadding="4" width="100%" bgcolor="#EAE8A9">
                                <tr>
                                    <td><p class="codigo">

                                        <pre>
 ; Cambio del color del borde al pulsar espacio
 ORG 50000

 LD B, 6              ; 6 iteraciones, color inicial borde

bucle:
 LD A, $7F            ; Semifila B a ESPACIO
 IN A, ($FE)          ; Leemos el puerto
 BIT 0, A             ; Testeamos el bit 0 (ESPACIO)
 JR NZ, bucle         ; Si esta a 1 (no pulsado), esperar

 LD A, B              ; A = B
 OUT (254), A         ; Cambiamos el color del borde

suelta_tecla:          ; Ahora esperamos a que se suelte la tecla
 LD A, $7F            ; Semifila B a ESPACIO
 IN A, ($FE)          ; Leemos el puerto
 BIT 0, A             ; Testeamos el bit 0
 JR Z, suelta_tecla   ; Saltamos hasta que se suelte

 djnz bucle           ; Repetimos "B" veces

salir:
 RET

 END 50000            ; Ejecucion en 50000
</pre>
                                        </p></td>
                                </tr>
                            </table>

                            <p></p>


                            <table border="0" cellspacing="0" cellpadding="2" width="320">
                                <tr align="right">
                                    <td><img src="img/borde.png" width="320" height="240"
                                             alt="Ejecución del programa de cambio de borde"/>
                                    </td>

                                </tr>
                                <tr>
                                    <td class="piefoto" align="right">Ejecución del programa de cambio de borde</td>
                                </tr>
                            </table>


                            <p>El puerto 7FFDh gestiona la <em>paginación en los modos de 128K</em>,
                                permitiendo cambiar el modelo de páginas de memoria (algo que
                                no vamos a ver en este capítulo).</p>

                            <p>Los puertos BFFDh y FFFDh gestionan el <em>chip de sonido</em> en aquellos
                                modelos que dispongan de él, así como el RS232/MIDI y el interfaz
                                AUX.</p>

                            <p>Finalmente, el puerto 0FFDh gestiona <em>el puerto paralelo de impresora</em>,
                                y los puertos 2FFDh y 3FFDh permiten gestionar la controladora de disco en
                                aquellos modelos de Spectrum que dispongan de ella.</p>

                            <p>Podéis encontrar más información sobre los puertos de Entrada y
                                Salida en el <em>capítulo 8 sección 23 del manual del +2A y +3</em>, disponible
                                online en World Of Spectrum.</p>


                            <p><b> Tabla de instrucciones, ciclos y tamaños </b></p>


                            <p>A continuación se incluye una tabla donde se hace referencia a las instrucciones
                                del microprocesador Z80 (campo Mnemonic), los ciclos de reloj que tarda en ejecutarse
                                (campo Clck), el tamaño en bytes de la instrucción codificada (Siz), la afectación
                                de Flags (SZHPNC), el opcode y su descripción en cuanto a ejecución.</p>

                            <p>La tabla forma parte de un documento llamado "<b>The Complete Z80 OP-Code Reference</b>",
                                de <em>Devin Gardner</em>.</p>

                            <table class="flags">

                                <tr>
                                    <th>Mnemonic</th>
                                    <th>Clck</th>
                                    <th>Size</th>
                                    <th>SZHPNC</th>
                                    <th> OP-Code</th>
                                    <th> Description</th>
                                    <th> Notes</th>
                                </tr>
                                <tr></tr>
                                <tr>
                                    <td>ADC A,r</td>
                                    <td> 4</td>
                                    <td> 1</td>
                                    <td>***V0*</td>
                                    <td>88+rb</td>
                                    <td>Add with Carry</td>
                                    <td>A=A+s+CY</td>
                                </tr>

                                <tr>
                                    <td>ADC A,N</td>
                                    <td> 7</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>CE XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>ADC A,(HL)</td>
                                    <td> 7</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>8E</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>ADC A,(IX+N)</td>
                                    <td> 19</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>DD 8E XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>ADC A,(IY+N)</td>
                                    <td> 19</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>FD 8E XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>ADC HL,BC</td>
                                    <td> 15</td>
                                    <td> 2</td>
                                    <td>**?V0*</td>
                                    <td>ED 4A</td>
                                    <td>Add with Carry</td>
                                    <td>HL=HL+ss+CY</td>
                                </tr>
                                <tr>
                                    <td>ADC HL,DE</td>
                                    <td> 15</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>ED 5A</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>ADC HL,HL</td>
                                    <td> 15</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>ED 6A</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>ADC HL,SP</td>
                                    <td> 15</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>ED 7A</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr></tr>
                                <tr>
                                    <td>ADD A,r</td>
                                    <td> 4</td>
                                    <td> 1</td>
                                    <td>***V0*</td>
                                    <td>80+rb</td>
                                    <td>Add (8-bit)</td>
                                    <td>A=A+s</td>
                                </tr>
                                <tr>
                                    <td>ADD A,N</td>
                                    <td> 7</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>C6 XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>ADD A,(HL)</td>
                                    <td> 7</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>86</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>ADD A,(IX+N)</td>
                                    <td> 19</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>DD 86 XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>ADD A,(IY+N)</td>
                                    <td> 19</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>FD 86 XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>ADD HL,BC</td>
                                    <td> 11</td>
                                    <td> 1</td>
                                    <td>--?-0*</td>
                                    <td>09</td>
                                    <td>Add (16-bit)</td>
                                    <td>HL=HL+ss</td>
                                </tr>

                                <tr>
                                    <td>ADD HL,DE</td>
                                    <td> 11</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>19</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>ADD HL,HL</td>
                                    <td> 11</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>29</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>ADD HL,SP</td>
                                    <td> 11</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>39</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>ADD IX,BC</td>
                                    <td> 15</td>
                                    <td> 2</td>
                                    <td>--?-0*</td>
                                    <td>DD 09</td>
                                    <td>Add (IX register)</td>
                                    <td>IX=IX+pp</td>
                                </tr>

                                <tr>
                                    <td>ADD IX,DE</td>
                                    <td> 15</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>DD 19</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>ADD IX,IX</td>
                                    <td> 15</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>DD 29</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>ADD IX,SP</td>
                                    <td> 15</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>DD 39</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>ADD IY,BC</td>
                                    <td> 15</td>
                                    <td> 2</td>
                                    <td>--?-0*</td>
                                    <td>FD 09</td>
                                    <td>Add (IY register)</td>
                                    <td>IY=IY+rr</td>
                                </tr>

                                <tr>
                                    <td>ADD IY,DE</td>
                                    <td> 15</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>FD 19</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>ADD IY,IY</td>
                                    <td> 15</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>FD 29</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>ADD IY,SP</td>
                                    <td> 15</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>FD 39</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr></tr>
                                <tr>
                                    <td>AND r</td>
                                    <td> 4</td>
                                    <td> 1</td>
                                    <td>***P00</td>
                                    <td>A0+rb</td>
                                    <td>Logical AND</td>
                                    <td>A=A&s</td>
                                </tr>

                                <tr>
                                    <td>AND N</td>
                                    <td> 7</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>E6 XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>AND (HL)</td>
                                    <td> 7</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>A6</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>AND (IX+N)</td>
                                    <td> 19</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>DD A6 XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>AND (IY+N)</td>
                                    <td> 19</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>FD A6 XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr></tr>
                                <tr>
                                    <td>BIT b,r</td>
                                    <td> 8</td>
                                    <td> 2</td>
                                    <td>?*1?0-</td>
                                    <td>CB 40+8*b+rb</td>
                                    <td>Test Bit</td>
                                    <td>m&{2^b}</td>
                                </tr>
                                <tr>
                                    <td>BIT b,(HL)</td>
                                    <td> 12</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>CB 46+8*b</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>BIT b,(IX+N)</td>
                                    <td> 20</td>
                                    <td> 4</td>
                                    <td></td>
                                    <td>DD CB</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td>XX 46+8*b</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>BIT b,(IY+N)</td>
                                    <td> 20</td>
                                    <td> 4</td>
                                    <td></td>
                                    <td>FD CB XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td>XX 46+8*b</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr></tr>
                                <tr>
                                    <td>CALL NN</td>
                                    <td> 17</td>
                                    <td> 3</td>
                                    <td>------</td>
                                    <td>CD XX XX</td>
                                    <td>Unconditional Call</td>
                                    <td>-(SP)=PC,PC=nn</td>
                                </tr>
                                <tr>
                                    <td>CALL C,NN</td>
                                    <td>17/1</td>
                                    <td> 3</td>
                                    <td>------</td>
                                    <td>DC XX XX</td>
                                    <td>Conditional Call</td>
                                    <td>If Carry = 1</td>
                                </tr>

                                <tr>
                                    <td>CALL NC,NN</td>
                                    <td>17/1</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>D4 XX XX</td>
                                    <td></td>
                                    <td>If carry = 0</td>
                                </tr>
                                <tr>
                                    <td>CALL M,NN</td>
                                    <td>17/1</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>FC XX XX</td>
                                    <td></td>
                                    <td>If Sign = 1 (negative)</td>
                                </tr>

                                <tr>
                                    <td>CALL P,NN</td>
                                    <td>17/1</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>F4 XX XX</td>
                                    <td></td>
                                    <td>If Sign = 0 (positive)</td>
                                </tr>
                                <tr>
                                    <td>CALL Z,NN</td>
                                    <td>17/1</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>CC XX XX</td>
                                    <td></td>
                                    <td>If Zero = 1 (ans.=0)</td>
                                </tr>

                                <tr>
                                    <td>CALL NZ,NN</td>
                                    <td>17/1</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>C4 XX XX</td>
                                    <td></td>
                                    <td>If Zero = 0 (non-zero)</td>
                                </tr>
                                <tr>
                                    <td>CALL PE,NN</td>
                                    <td>17/1</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>EC XX XX</td>
                                    <td></td>
                                    <td>If Parity = 1 (even)</td>
                                </tr>

                                <tr>
                                    <td>CALL PO,NN</td>
                                    <td>17/1</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>E4 XX XX</td>
                                    <td></td>
                                    <td>If Parity = 0 (odd)</td>
                                </tr>
                                <tr></tr>
                                <tr>
                                    <td>CCF</td>
                                    <td> 4</td>
                                    <td> 1</td>
                                    <td>--?-0*</td>
                                    <td>3F</td>
                                    <td>Complement Carry Flag</td>
                                    <td>CY=~CY</td>
                                </tr>

                                <tr></tr>
                                <tr>
                                    <td>CP r</td>
                                    <td> 4</td>
                                    <td> 1</td>
                                    <td>***V1*</td>
                                    <td>B8+rb</td>
                                    <td>Compare</td>
                                    <td>Compare A-s</td>
                                </tr>
                                <tr>
                                    <td>CP N</td>
                                    <td> 7</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>FE XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>CP (HL)</td>
                                    <td> 7</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>BE</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>CP (IX+N)</td>
                                    <td> 19</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>DD BE XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>CP (IY+N)</td>
                                    <td> 19</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>FD BE XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>CPD</td>
                                    <td> 16</td>
                                    <td> 2</td>
                                    <td>****1-</td>
                                    <td>ED A9</td>
                                    <td>Compare and Decrement</td>
                                    <td>A-(HL),HL=HL-1,BC=BC-1</td>
                                </tr>

                                <tr>
                                    <td>CPDR</td>
                                    <td>21/1</td>
                                    <td> 2</td>
                                    <td>****1-</td>
                                    <td>ED B9</td>
                                    <td>Compare, Dec., Repeat</td>
                                    <td>CPD till A=(HL)or BC=0</td>
                                </tr>
                                <tr>
                                    <td>CPI</td>
                                    <td> 16</td>
                                    <td> 2</td>
                                    <td>****1-</td>
                                    <td>ED A1</td>
                                    <td>Compare and Increment</td>
                                    <td>A-(HL),HL=HL+1,BC=BC-1</td>
                                </tr>

                                <tr>
                                    <td>CPIR</td>
                                    <td>21/1</td>
                                    <td> 2</td>
                                    <td>****1-</td>
                                    <td>ED B1</td>
                                    <td>Compare, Inc., Repeat</td>
                                    <td>CPI till A=(HL)or BC=0</td>
                                </tr>
                                <tr></tr>
                                <tr>
                                    <td>CPL</td>
                                    <td> 4</td>
                                    <td> 1</td>
                                    <td>--1-1-</td>
                                    <td>2F</td>
                                    <td>Complement</td>
                                    <td>A=~A</td>
                                </tr>

                                <tr></tr>
                                <tr>
                                    <td>DAA</td>
                                    <td> 4</td>
                                    <td> 1</td>
                                    <td>***P-*</td>
                                    <td>27</td>
                                    <td>Decimal Adjust Acc.</td>
                                    <td>A=BCD format (dec.)</td>
                                </tr>
                                <tr></tr>
                                <tr>
                                    <td>DEC A</td>
                                    <td> 4</td>
                                    <td> 1</td>
                                    <td>***V1-</td>
                                    <td>3D</td>
                                    <td>Decrement (8-bit)</td>
                                    <td>s=s-1</td>
                                </tr>

                                <tr>
                                    <td>DEC B</td>
                                    <td> 4</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>05</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>DEC C</td>
                                    <td> 4</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>0D</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>DEC D</td>
                                    <td> 4</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>15</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>DEC E</td>
                                    <td> 4</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>1D</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>DEC H</td>
                                    <td> 4</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>25</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>DEC L</td>
                                    <td> 4</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>2D</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>DEC (HL)</td>
                                    <td> 11</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>35</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>DEC (IX+N)</td>
                                    <td> 23</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>DD 35 XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>DEC (IY+N)</td>
                                    <td> 23</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>FD 35 XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>DEC BC</td>
                                    <td> 6</td>
                                    <td> 1</td>
                                    <td>------</td>
                                    <td>0B</td>
                                    <td>Decrement (16-bit)</td>
                                    <td>ss=ss-1</td>
                                </tr>

                                <tr>
                                    <td>DEC DE</td>
                                    <td> 6</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>1B</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>DEC HL</td>
                                    <td> 6</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>2B</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>DEC SP</td>
                                    <td> 6</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>3B</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>DEC IX</td>
                                    <td> 10</td>
                                    <td> 2</td>
                                    <td>------</td>
                                    <td>DD 2B</td>
                                    <td>Decrement</td>
                                    <td>xx=xx-1</td>
                                </tr>

                                <tr>
                                    <td>DEC IY</td>
                                    <td> 10</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>FD 2B</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr></tr>
                                <tr>
                                    <td>DI</td>
                                    <td> 4</td>
                                    <td> 1</td>
                                    <td>------</td>
                                    <td>F3</td>
                                    <td>Disable Interrupts</td>
                                    <td></td>
                                </tr>

                                <tr></tr>
                                <tr>
                                    <td>DJNZ $+2</td>
                                    <td>13/8</td>
                                    <td> 1</td>
                                    <td>------</td>
                                    <td>10</td>
                                    <td>Dec., Jump Non-Zero</td>
                                    <td>B=B-1 till B=0</td>
                                </tr>
                                <tr></tr>
                                <tr>
                                    <td>EI</td>
                                    <td> 4</td>
                                    <td> 1</td>
                                    <td>------</td>
                                    <td>FB</td>
                                    <td>Enable Interrupts</td>
                                    <td></td>
                                </tr>

                                <tr></tr>
                                <tr>
                                    <td>EX (SP),HL</td>
                                    <td> 19</td>
                                    <td> 1</td>
                                    <td>------</td>
                                    <td>E3</td>
                                    <td>Exchange</td>
                                    <td>(SP)<->HL</td>
                                </tr>
                                <tr>
                                    <td>EX (SP),IX</td>
                                    <td> 23</td>
                                    <td> 2</td>
                                    <td>------</td>
                                    <td>DD E3</td>
                                    <td></td>
                                    <td>(SP)<->xx</td>
                                </tr>

                                <tr>
                                    <td>EX (SP),IY</td>
                                    <td> 23</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>FD E3</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>EX AF,AF'</td>
                                    <td> 4</td>
                                    <td> 1</td>
                                    <td>------</td>
                                    <td>08</td>
                                    <td></td>
                                    <td>AF<->AF'</td>
                                </tr>

                                <tr>
                                    <td>EX DE,HL</td>
                                    <td> 4</td>
                                    <td> 1</td>
                                    <td>------</td>
                                    <td>EB</td>
                                    <td></td>
                                    <td>DE<->HL</td>
                                </tr>
                                <tr>
                                    <td>EXX</td>
                                    <td> 4</td>
                                    <td> 1</td>
                                    <td>------</td>
                                    <td>D9</td>
                                    <td>Exchange</td>
                                    <td>qq<->qq' (except AF)</td>
                                </tr>

                                <tr></tr>
                                <tr>
                                    <td>HALT</td>
                                    <td> 4</td>
                                    <td> 1</td>
                                    <td>------</td>
                                    <td>76</td>
                                    <td>Halt</td>
                                    <td></td>
                                </tr>
                                <tr></tr>
                                <tr>
                                    <td>IM 0</td>
                                    <td> 8</td>
                                    <td> 2</td>
                                    <td>------</td>
                                    <td>ED 46</td>
                                    <td>Interrupt Mode</td>
                                    <td> (n=0,1,2)</td>
                                </tr>

                                <tr>
                                    <td>IM 1</td>
                                    <td> 8</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>ED 56</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>IM 2</td>
                                    <td> 8</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>ED 5E</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr></tr>
                                <tr>
                                    <td>IN A,(N)</td>
                                    <td> 11</td>
                                    <td> 2</td>
                                    <td>------</td>
                                    <td>DB XX</td>
                                    <td>Input</td>
                                    <td>A=(n)</td>
                                </tr>
                                <tr>
                                    <td>IN (C)</td>
                                    <td> 12</td>
                                    <td> 2</td>
                                    <td>***P0-</td>
                                    <td>ED 70</td>
                                    <td>Input*</td>
                                    <td> (Unsupported)</td>
                                </tr>

                                <tr>
                                    <td>IN A,(C)</td>
                                    <td> 12</td>
                                    <td> 2</td>
                                    <td>***P0-</td>
                                    <td>ED 78</td>
                                    <td>Input</td>
                                    <td>r=(C)</td>
                                </tr>
                                <tr>
                                    <td>IN B,(C)</td>
                                    <td> 12</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>ED 40</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>IN C,(C)</td>
                                    <td> 12</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>ED 48</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>IN D,(C)</td>
                                    <td> 12</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>ED 50</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>IN E,(C)</td>
                                    <td> 12</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>ED 58</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>IN H,(C)</td>
                                    <td> 12</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>ED 60</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>IN L,(C)</td>
                                    <td> 12</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>ED 68</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr></tr>
                                <tr>
                                    <td>INC A</td>
                                    <td> 4</td>
                                    <td> 1</td>
                                    <td>***V0-</td>
                                    <td>3C</td>
                                    <td>Increment (8-bit)</td>
                                    <td>r=r+1</td>
                                </tr>

                                <tr>
                                    <td>INC B</td>
                                    <td> 4</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>04</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>INC C</td>
                                    <td> 4</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>0C</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>INC D</td>
                                    <td> 4</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>14</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>INC E</td>
                                    <td> 4</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>1C</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>INC H</td>
                                    <td> 4</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>24</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>INC L</td>
                                    <td> 4</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>2C</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>INC BC</td>
                                    <td> 6</td>
                                    <td> 1</td>
                                    <td>------</td>
                                    <td>03</td>
                                    <td>Increment (16-bit)</td>
                                    <td>ss=ss+1</td>
                                </tr>
                                <tr>
                                    <td>INC DE</td>
                                    <td> 6</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>13</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>INC HL</td>
                                    <td> 6</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>23</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>INC SP</td>
                                    <td> 6</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>33</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>INC IX</td>
                                    <td> 10</td>
                                    <td> 2</td>
                                    <td>------</td>
                                    <td>DD 23</td>
                                    <td>Increment</td>
                                    <td>xx=xx+1</td>
                                </tr>
                                <tr>
                                    <td>INC IY</td>
                                    <td> 10</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>FD 23</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>INC (HL)</td>
                                    <td> 11</td>
                                    <td> 1</td>
                                    <td>***V0-</td>
                                    <td>34</td>
                                    <td>Increment (indirect)</td>
                                    <td>(HL)=(HL)+1</td>
                                </tr>
                                <tr>
                                    <td>INC (IX+N)</td>
                                    <td> 23</td>
                                    <td> 3</td>
                                    <td>***V0-</td>
                                    <td>DD 34 XX</td>
                                    <td>Increment</td>
                                    <td>(xx+d)=(xx+d)+1</td>
                                </tr>

                                <tr>
                                    <td>INC (IY+N)</td>
                                    <td> 23</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>FD 34 XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr></tr>
                                <tr>
                                    <td>IND</td>
                                    <td> 16</td>
                                    <td> 2</td>
                                    <td>?*??1-</td>
                                    <td>ED AA</td>
                                    <td>Input and Decrement</td>
                                    <td>(HL)=(C),HL=HL-1,B=B-1</td>
                                </tr>

                                <tr>
                                    <td>INDR</td>
                                    <td>21/1</td>
                                    <td> 2</td>
                                    <td>?1??1-</td>
                                    <td>ED BA</td>
                                    <td>Input, Dec., Repeat</td>
                                    <td>IND till B=0</td>
                                </tr>
                                <tr>
                                    <td>INI</td>
                                    <td> 16</td>
                                    <td> 2</td>
                                    <td>?*??1-</td>
                                    <td>ED A2</td>
                                    <td>Input and Increment</td>
                                    <td>(HL)=(C),HL=HL+1,B=B-1</td>
                                </tr>

                                <tr>
                                    <td>INIR</td>
                                    <td>21/1</td>
                                    <td> 2</td>
                                    <td>?1??1-</td>
                                    <td>ED B2</td>
                                    <td>Input, Inc., Repeat</td>
                                    <td>INI till B=0</td>
                                </tr>
                                <tr></tr>
                                <tr>
                                    <td>JP $NN</td>
                                    <td> 10</td>
                                    <td> 3</td>
                                    <td>------</td>
                                    <td>C3 XX XX</td>
                                    <td>Unconditional Jump</td>
                                    <td>PC=nn</td>
                                </tr>

                                <tr>
                                    <td>JP (HL)</td>
                                    <td> 4</td>
                                    <td> 1</td>
                                    <td>------</td>
                                    <td>E9</td>
                                    <td>Unconditional Jump</td>
                                    <td>PC=(HL)</td>
                                </tr>
                                <tr>
                                    <td>JP (IX)</td>
                                    <td> 8</td>
                                    <td> 2</td>
                                    <td>------</td>
                                    <td>DD E9</td>
                                    <td>Unconditional Jump</td>
                                    <td>PC=(xx)</td>
                                </tr>

                                <tr>
                                    <td>JP (IY)</td>
                                    <td> 8</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>FD E9</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>JP C,$NN</td>
                                    <td>10/1</td>
                                    <td> 3</td>
                                    <td>------</td>
                                    <td>DA XX XX</td>
                                    <td>Conditional Jump</td>
                                    <td>If Carry = 1</td>
                                </tr>

                                <tr>
                                    <td>JP NC,$NN</td>
                                    <td>10/1</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>D2 XX XX</td>
                                    <td></td>
                                    <td>If Carry = 0</td>
                                </tr>
                                <tr>
                                    <td>JP M,$NN</td>
                                    <td>10/1</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>FA XX XX</td>
                                    <td></td>
                                    <td>If Sign = 1 (negative)</td>
                                </tr>

                                <tr>
                                    <td>JP P,$NN</td>
                                    <td>10/1</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>F2 XX XX</td>
                                    <td></td>
                                    <td>If Sign = 0 (positive)</td>
                                </tr>
                                <tr>
                                    <td>JP Z,$NN</td>
                                    <td>10/1</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>CA XX XX</td>
                                    <td></td>
                                    <td>If Zero = 1 (ans.= 0)</td>
                                </tr>

                                <tr>
                                    <td>JP NZ,$NN</td>
                                    <td>10/1</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>C2 XX XX</td>
                                    <td></td>
                                    <td>If Zero = 0 (non-zero)</td>
                                </tr>
                                <tr>
                                    <td>JP PE,$NN</td>
                                    <td>10/1</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>EA XX XX</td>
                                    <td></td>
                                    <td>If Parity = 1 (even)</td>
                                </tr>

                                <tr>
                                    <td>JP PO,$NN</td>
                                    <td>10/1</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>E2 XX XX</td>
                                    <td></td>
                                    <td>If Parity = 0 (odd)</td>
                                </tr>
                                <tr></tr>
                                <tr>
                                    <td>JR $N+2</td>
                                    <td> 12</td>
                                    <td> 2</td>
                                    <td>------</td>
                                    <td>18 XX</td>
                                    <td>Relative Jump</td>
                                    <td>PC=PC+e</td>
                                </tr>

                                <tr>
                                    <td>JR C,$N+2</td>
                                    <td>12/7</td>
                                    <td> 2</td>
                                    <td>------</td>
                                    <td>38 XX</td>
                                    <td>Cond. Relative Jump</td>
                                    <td>If cc JR(cc=C,NC,NZ,Z)</td>
                                </tr>
                                <tr>
                                    <td>JR NC,$N+2</td>
                                    <td>12/7</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>30 XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>JR Z,$N+2</td>
                                    <td>12/7</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>28 XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>JR NZ,$N+2</td>
                                    <td>12/7</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>20 XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr></tr>
                                <tr>
                                    <td>LD I,A</td>
                                    <td> 9</td>
                                    <td> 2</td>
                                    <td>------</td>
                                    <td>ED 47</td>
                                    <td>Load*</td>
                                    <td>dst=src</td>
                                </tr>
                                <tr>
                                    <td>LD R,A</td>
                                    <td> 9</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>ED 4F</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>LD A,I</td>
                                    <td> 9</td>
                                    <td> 2</td>
                                    <td>**0*0-</td>
                                    <td>ED 57</td>
                                    <td>Load*</td>
                                    <td>dst=src</td>
                                </tr>
                                <tr>
                                    <td>LD A,R</td>
                                    <td> 9</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>ED 5F</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>LD A,r</td>
                                    <td> 4</td>
                                    <td> 1</td>
                                    <td>------</td>
                                    <td>78+rb</td>
                                    <td>Load (8-bit)</td>
                                    <td>dst=src</td>
                                </tr>
                                <tr>
                                    <td>LD A,N</td>
                                    <td> 7</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>3E XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>LD A,(BC)</td>
                                    <td> 7</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>0A</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>LD A,(DE)</td>
                                    <td> 7</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>1A</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>LD A,(HL)</td>
                                    <td> 7</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>7E</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>LD A,(IX+N)</td>
                                    <td> 19</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>DD 7E XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>LD A,(IY+N)</td>
                                    <td> 19</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>FD 7E XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>LD A,(NN)</td>
                                    <td> 13</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>3A XX XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>LD B,r</td>
                                    <td> 4</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>40+rb</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>LD B,N</td>
                                    <td> 7</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>06 XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>LD B,(HL)</td>
                                    <td> 7</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>46</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>LD B,(IX+N)</td>
                                    <td> 19</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>DD 46 XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>LD B,(IY+N)</td>
                                    <td> 19</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>FD 46 XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>LD C,r</td>
                                    <td> 4</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>48+rb</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>LD C,N</td>
                                    <td> 7</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>0E XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>LD C,(HL)</td>
                                    <td> 7</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>4E</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>LD C,(IX+N)</td>
                                    <td> 19</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>DD 4E XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>LD C,(IY+N)</td>
                                    <td> 19</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>FD 4E XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>LD D,r</td>
                                    <td> 4</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>50+rb</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>LD D,N</td>
                                    <td> 7</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>16 XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>LD D,(HL)</td>
                                    <td> 7</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>56</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>LD D,(IX+N)</td>
                                    <td> 19</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>DD 56 XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>LD D,(IY+N)</td>
                                    <td> 19</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>FD 56 XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>LD E,r</td>
                                    <td> 4</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>58+rb</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>LD E,N</td>
                                    <td> 7</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>1E XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>LD E,(HL)</td>
                                    <td> 7</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>5E</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>LD E,(IX+N)</td>
                                    <td> 19</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>DD 5E XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>LD E,(IY+N)</td>
                                    <td> 19</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>FD 5E XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>LD H,r</td>
                                    <td> 4</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>60+rb</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>LD H,N</td>
                                    <td> 7</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>26 XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>LD H,(HL)</td>
                                    <td> 7</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>66</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>LD H,(IX+N)</td>
                                    <td> 19</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>DD 66 XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>LD H,(IY+N)</td>
                                    <td> 19</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>FD 66 XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>LD L,r</td>
                                    <td> 4</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>68+rb</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>LD L,N</td>
                                    <td> 7</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>2E XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>LD L,(HL)</td>
                                    <td> 7</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>6E</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>LD L,(IX+N)</td>
                                    <td> 19</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>DD 6E XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>LD L,(IY+N)</td>
                                    <td> 19</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>FD 6E XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>LD BC,(NN)</td>
                                    <td> 20</td>
                                    <td> 4</td>
                                    <td>------</td>
                                    <td>ED 4B XX XX</td>
                                    <td>Load (16-bit)</td>
                                    <td>dst=src</td>
                                </tr>
                                <tr>
                                    <td>LD BC,NN</td>
                                    <td> 10</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>01 XX XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>LD DE,(NN)</td>
                                    <td> 20</td>
                                    <td> 4</td>
                                    <td></td>
                                    <td>ED 5B XX XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>LD DE,NN</td>
                                    <td> 10</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>11 XX XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>LD HL,(NN)</td>
                                    <td> 20</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>2A XX XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>LD HL,NN</td>
                                    <td> 10</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>21 XX XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>LD SP,(NN)</td>
                                    <td> 20</td>
                                    <td> 4</td>
                                    <td></td>
                                    <td>ED 7B XX XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>LD SP,HL</td>
                                    <td> 6</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>F9</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>LD SP,IX</td>
                                    <td> 10</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>DD F9</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>LD SP,IY</td>
                                    <td> 10</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>FD F9</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>LD SP,NN</td>
                                    <td> 10</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>31 XX XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>LD IX,(NN)</td>
                                    <td> 20</td>
                                    <td> 4</td>
                                    <td></td>
                                    <td>DD 2A XX XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>LD IX,NN</td>
                                    <td> 14</td>
                                    <td> 4</td>
                                    <td></td>
                                    <td>DD 21 XX XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>LD IY,(NN)</td>
                                    <td> 20</td>
                                    <td> 4</td>
                                    <td></td>
                                    <td>FD 2A XX XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>LD IY,NN</td>
                                    <td> 14</td>
                                    <td> 4</td>
                                    <td></td>
                                    <td>FD 21 XX XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>LD (HL),r</td>
                                    <td> 7</td>
                                    <td> 1</td>
                                    <td>------</td>
                                    <td>70+rb</td>
                                    <td>Load (Indirect)</td>
                                    <td>dst=src</td>
                                </tr>

                                <tr>
                                    <td>LD (HL),N</td>
                                    <td> 10</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>36 XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>LD (BC),A</td>
                                    <td> 7</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>02</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>LD (DE),A</td>
                                    <td> 7</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>12</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>LD (NN),A</td>
                                    <td> 13</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>32 XX XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>LD (NN),BC</td>
                                    <td> 20</td>
                                    <td> 4</td>
                                    <td></td>
                                    <td>ED 43 XX XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>LD (NN),DE</td>
                                    <td> 20</td>
                                    <td> 4</td>
                                    <td></td>
                                    <td>ED 53 XX XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>LD (NN),HL</td>
                                    <td> 16</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>22 XX XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>LD (NN),IX</td>
                                    <td> 20</td>
                                    <td> 4</td>
                                    <td></td>
                                    <td>DD 22 XX XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>LD (NN),IY</td>
                                    <td> 20</td>
                                    <td> 4</td>
                                    <td></td>
                                    <td>FD 22 XX XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>LD (NN),SP</td>
                                    <td> 20</td>
                                    <td> 4</td>
                                    <td></td>
                                    <td>ED 73 XX XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>LD (IX+N),r</td>
                                    <td> 19</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>DD 70+rb XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>LD (IX+N),N</td>
                                    <td> 19</td>
                                    <td> 4</td>
                                    <td></td>
                                    <td>DD 36 XX XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>LD (IY+N),r</td>
                                    <td> 19</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>FD 70+rb XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>LD (IY+N),N</td>
                                    <td> 19</td>
                                    <td> 4</td>
                                    <td></td>
                                    <td>FD 36 XX XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr></tr>
                                <tr>
                                    <td>LDD</td>
                                    <td> 16</td>
                                    <td> 2</td>
                                    <td>--0*0-</td>
                                    <td>ED A8</td>
                                    <td>Load and Decrement</td>
                                    <td>(DE)=(HL),HL=HL-1,#</td>
                                </tr>
                                <tr>
                                    <td>LDDR</td>
                                    <td>21/1</td>
                                    <td> 2</td>
                                    <td>--000-</td>
                                    <td>ED B8</td>
                                    <td>Load, Dec., Repeat</td>
                                    <td>LDD till BC=0</td>
                                </tr>

                                <tr>
                                    <td>LDI</td>
                                    <td> 16</td>
                                    <td> 2</td>
                                    <td>--0*0-</td>
                                    <td>ED A0</td>
                                    <td>Load and Increment</td>
                                    <td>(DE)=(HL),HL=HL+1,#</td>
                                </tr>
                                <tr>
                                    <td>LDIR</td>
                                    <td>21/1</td>
                                    <td> 2</td>
                                    <td>--000-</td>
                                    <td>ED B0</td>
                                    <td>Load, Inc., Repeat</td>
                                    <td>LDI till BC=0</td>
                                </tr>

                                <tr></tr>
                                <tr>
                                    <td>NEG</td>
                                    <td> 8</td>
                                    <td> 2</td>
                                    <td>***V1*</td>
                                    <td>ED 44</td>
                                    <td>Negate</td>
                                    <td>A=-A</td>
                                </tr>
                                <tr></tr>
                                <tr>
                                    <td>NOP</td>
                                    <td> 4</td>
                                    <td> 1</td>
                                    <td>------</td>
                                    <td>00</td>
                                    <td>No Operation</td>
                                    <td></td>
                                </tr>

                                <tr></tr>
                                <tr>
                                    <td>OR r</td>
                                    <td> 4</td>
                                    <td> 1</td>
                                    <td>***P00</td>
                                    <td>B0+rb</td>
                                    <td>Logical inclusive OR</td>
                                    <td>A=Avs</td>
                                </tr>
                                <tr>
                                    <td>OR N</td>
                                    <td> 7</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>F6 XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>OR (HL)</td>
                                    <td> 7</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>B6</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>OR (IX+N)</td>
                                    <td> 19</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>DD B6 XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>OR (IY+N)</td>
                                    <td> 19</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>FD B6 XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr></tr>
                                <tr>
                                    <td>OUT (N),A</td>
                                    <td> 11</td>
                                    <td> 2</td>
                                    <td>------</td>
                                    <td>D3 XX</td>
                                    <td>Output</td>
                                    <td>(n)=A</td>
                                </tr>

                                <tr>
                                    <td>OUT (C),0</td>
                                    <td> 12</td>
                                    <td> 2</td>
                                    <td>------</td>
                                    <td>ED 71</td>
                                    <td>Output*</td>
                                    <td> (Unsupported)</td>
                                </tr>
                                <tr>
                                    <td>OUT (C),A</td>
                                    <td> 12</td>
                                    <td> 2</td>
                                    <td>------</td>
                                    <td>ED 79</td>
                                    <td>Output</td>
                                    <td>(C)=r</td>
                                </tr>

                                <tr>
                                    <td>OUT (C),B</td>
                                    <td> 12</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>ED 41</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>OUT (C),C</td>
                                    <td> 12</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>ED 49</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>OUT (C),D</td>
                                    <td> 12</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>ED 51</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>OUT (C),E</td>
                                    <td> 12</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>ED 59</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>OUT (C),H</td>
                                    <td> 12</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>ED 61</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>OUT (C),L</td>
                                    <td> 12</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>ED 69</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr></tr>
                                <tr>
                                    <td>OUTD</td>
                                    <td> 16</td>
                                    <td> 2</td>
                                    <td>?*??1-</td>
                                    <td>ED AB</td>
                                    <td>Output and Decrement</td>
                                    <td>(C)=(HL),HL=HL-1,B=B-1</td>
                                </tr>
                                <tr>
                                    <td>OTDR</td>
                                    <td>21/1</td>
                                    <td> 2</td>
                                    <td>?1??1-</td>
                                    <td>ED BB</td>
                                    <td>Output, Dec., Repeat</td>
                                    <td>OUTD till B=0</td>
                                </tr>

                                <tr>
                                    <td>OUTI</td>
                                    <td> 16</td>
                                    <td> 2</td>
                                    <td>?*??1-</td>
                                    <td>ED A3</td>
                                    <td>Output and Increment</td>
                                    <td>(C)=(HL),HL=HL+1,B=B-1</td>
                                </tr>
                                <tr>
                                    <td>OTIR</td>
                                    <td>21/1</td>
                                    <td> 2</td>
                                    <td>?1??1-</td>
                                    <td>ED B3</td>
                                    <td>Output, Inc., Repeat</td>
                                    <td>OUTI till B=0</td>
                                </tr>

                                <tr></tr>
                                <tr>
                                    <td>POP AF</td>
                                    <td> 10</td>
                                    <td> 1</td>
                                    <td>------</td>
                                    <td>F1</td>
                                    <td>Pop</td>
                                    <td>qq=(SP)+</td>
                                </tr>
                                <tr>
                                    <td>POP BC</td>
                                    <td> 10</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>C1</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>POP DE</td>
                                    <td> 10</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>D1</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>POP HL</td>
                                    <td> 10</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>E1</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>POP IX</td>
                                    <td> 14</td>
                                    <td> 2</td>
                                    <td>------</td>
                                    <td>DD E1</td>
                                    <td>Pop</td>
                                    <td>xx=(SP)+</td>
                                </tr>
                                <tr>
                                    <td>POP IY</td>
                                    <td> 14</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>FD E1</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>PUSH AF</td>
                                    <td> 11</td>
                                    <td> 1</td>
                                    <td>------</td>
                                    <td>F5</td>
                                    <td>Push</td>
                                    <td>-(SP)=qq</td>
                                </tr>
                                <tr>
                                    <td>PUSH BC</td>
                                    <td> 11</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>C5</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>PUSH DE</td>
                                    <td> 11</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>D5</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>PUSH HL</td>
                                    <td> 11</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>E5</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>PUSH IX</td>
                                    <td> 15</td>
                                    <td> 2</td>
                                    <td>------</td>
                                    <td>DD E5</td>
                                    <td>Push</td>
                                    <td>-(SP)=xx</td>
                                </tr>
                                <tr>
                                    <td>PUSH IY</td>
                                    <td> 15</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>FD E5</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr></tr>
                                <tr>
                                    <td>RES b,r</td>
                                    <td> 8</td>
                                    <td> 2</td>
                                    <td>------</td>
                                    <td>CB 80+8*b+rb</td>
                                    <td>Reset bit</td>
                                    <td>m=m&{~2^b}</td>
                                </tr>
                                <tr>
                                    <td>RES b,(HL)</td>
                                    <td> 15</td>
                                    <td> 2</td>
                                    <td>------</td>
                                    <td>CB 86+8*b</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>RES b,(IX+N)</td>
                                    <td> 23</td>
                                    <td> 4</td>
                                    <td>------</td>
                                    <td>DD CB</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td>XX 86+8*b</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>RES b,(IY+N)</td>
                                    <td> 23</td>
                                    <td> 4</td>
                                    <td>------</td>
                                    <td>FD CB</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td>XX 86+8*b</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr></tr>
                                <tr>
                                    <td>RET</td>
                                    <td> 10</td>
                                    <td> 1</td>
                                    <td>------</td>
                                    <td>C9</td>
                                    <td>Return</td>
                                    <td>PC=(SP)+</td>
                                </tr>
                                <tr>
                                    <td>RET C</td>
                                    <td>11/5</td>
                                    <td> 1</td>
                                    <td>------</td>
                                    <td>D8</td>
                                    <td>Conditional Return</td>
                                    <td>If Carry = 1</td>
                                </tr>

                                <tr>
                                    <td>RET NC</td>
                                    <td>11/5</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>D0</td>
                                    <td></td>
                                    <td>If Carry = 0</td>
                                </tr>
                                <tr>
                                    <td>RET M</td>
                                    <td>11/5</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>F8</td>
                                    <td></td>
                                    <td>If Sign = 1 (negative)</td>
                                </tr>

                                <tr>
                                    <td>RET P</td>
                                    <td>11/5</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>F0</td>
                                    <td></td>
                                    <td>If Sign = 0 (positive)</td>
                                </tr>
                                <tr>
                                    <td>RET Z</td>
                                    <td>11/5</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>C8</td>
                                    <td></td>
                                    <td>If Zero = 1 (ans.=0)</td>
                                </tr>

                                <tr>
                                    <td>RET NZ</td>
                                    <td>11/5</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>C0</td>
                                    <td></td>
                                    <td>If Zero = 0 (non-zero)</td>
                                </tr>
                                <tr>
                                    <td>RET PE</td>
                                    <td>11/5</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>E8</td>
                                    <td></td>
                                    <td>If Parity = 1 (even)</td>
                                </tr>

                                <tr>
                                    <td>RET PO</td>
                                    <td>11/5</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>E0</td>
                                    <td></td>
                                    <td>If Parity = 0 (odd)</td>
                                </tr>
                                <tr></tr>
                                <tr>
                                    <td>RETI</td>
                                    <td> 14</td>
                                    <td> 2</td>
                                    <td>------</td>
                                    <td>ED 4D</td>
                                    <td>Return from Interrupt</td>
                                    <td>PC=(SP)+</td>
                                </tr>

                                <tr>
                                    <td>RETN</td>
                                    <td> 14</td>
                                    <td> 2</td>
                                    <td>------</td>
                                    <td>ED 45</td>
                                    <td>Return from NMI</td>
                                    <td>PC=(SP)+</td>
                                </tr>
                                <tr></tr>
                                <tr>
                                    <td>RLA</td>
                                    <td> 4</td>
                                    <td> 1</td>
                                    <td>--0-0*</td>
                                    <td>17</td>
                                    <td>Rotate Left Acc.</td>
                                    <td>A={CY,A}<-</td>
                                </tr>

                                <tr>
                                    <td>RL r</td>
                                    <td> 8</td>
                                    <td> 2</td>
                                    <td>**0P0*</td>
                                    <td>CB 10+rb</td>
                                    <td>Rotate Left</td>
                                    <td>m={CY,m}<-</td>
                                </tr>
                                <tr>
                                    <td>RL (HL)</td>
                                    <td> 15</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>CB 16</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>RL (IX+N)</td>
                                    <td> 23</td>
                                    <td> 4</td>
                                    <td></td>
                                    <td>DD CB XX 16</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>RL (IY+N)</td>
                                    <td> 23</td>
                                    <td> 4</td>
                                    <td></td>
                                    <td>FD CB XX 16</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>RLCA</td>
                                    <td> 4</td>
                                    <td> 1</td>
                                    <td>--0-0*</td>
                                    <td>07</td>
                                    <td>Rotate Left Cir. Acc.</td>
                                    <td>A=A<-</td>
                                </tr>
                                <tr>
                                    <td>RLC r</td>
                                    <td> 8</td>
                                    <td> 2</td>
                                    <td>**0P0*</td>
                                    <td>CB 00+rb</td>
                                    <td>Rotate Left Circular</td>
                                    <td>m=m<-</td>
                                </tr>

                                <tr>
                                    <td>RLC (HL)</td>
                                    <td> 15</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>CB 06</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>RLC (IX+N)</td>
                                    <td> 23</td>
                                    <td> 4</td>
                                    <td></td>
                                    <td>DD CB XX 06</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>RLC (IY+N)</td>
                                    <td> 23</td>
                                    <td> 4</td>
                                    <td></td>
                                    <td>FD CB XX 06</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>RLD</td>
                                    <td> 18</td>
                                    <td> 2</td>
                                    <td>**0P0-</td>
                                    <td>ED 6F</td>
                                    <td>Rotate Left 4 bits</td>
                                    <td>{A,(HL)}={A,(HL)}<- ##</td>
                                </tr>

                                <tr>
                                    <td>RRA</td>
                                    <td> 4</td>
                                    <td> 1</td>
                                    <td>--0-0*</td>
                                    <td>1F</td>
                                    <td>Rotate Right Acc.</td>
                                    <td>A=->{CY,A}</td>
                                </tr>
                                <tr>
                                    <td>RR r</td>
                                    <td> 8</td>
                                    <td> 2</td>
                                    <td>**0P0*</td>
                                    <td>CB 18+rb</td>
                                    <td>Rotate Right</td>
                                    <td>m=->{CY,m}</td>
                                </tr>

                                <tr>
                                    <td>RR (HL)</td>
                                    <td> 15</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>CB 1E</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>RR (IX+N)</td>
                                    <td> 23</td>
                                    <td> 4</td>
                                    <td></td>
                                    <td>DD CB XX 1E</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>RR (IY+N)</td>
                                    <td> 23</td>
                                    <td> 4</td>
                                    <td></td>
                                    <td>FD CB XX 1E</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>RRCA</td>
                                    <td> 4</td>
                                    <td> 1</td>
                                    <td>--0-0*</td>
                                    <td>0F</td>
                                    <td>Rotate Right Cir.Acc.</td>
                                    <td>A=->A</td>
                                </tr>

                                <tr>
                                    <td>RRC r</td>
                                    <td> 8</td>
                                    <td> 2</td>
                                    <td>**0P0*</td>
                                    <td>CB 08+rb</td>
                                    <td>Rotate Right Circular</td>
                                    <td>m=->m</td>
                                </tr>
                                <tr>
                                    <td>RRC (HL)</td>
                                    <td> 15</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>CB 0E</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>RRC (IX+N)</td>
                                    <td> 23</td>
                                    <td> 4</td>
                                    <td></td>
                                    <td>DD CB XX 0E</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>RRC (IY+N)</td>
                                    <td> 23</td>
                                    <td> 4</td>
                                    <td></td>
                                    <td>FD CB XX 0E</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>RRD</td>
                                    <td> 18</td>
                                    <td> 2</td>
                                    <td>**0P0-</td>
                                    <td>ED 67</td>
                                    <td>Rotate Right 4 bits</td>
                                    <td>{A,(HL)}=->{A,(HL)} ##</td>
                                </tr>
                                <tr></tr>
                                <tr>
                                    <td>RST 0</td>
                                    <td> 11</td>
                                    <td> 1</td>
                                    <td>------</td>
                                    <td>C7</td>
                                    <td>Restart</td>
                                    <td> (p=0H,8H,10H,...,38H)</td>
                                </tr>

                                <tr>
                                    <td>RST 08H</td>
                                    <td> 11</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>CF</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>RST 10H</td>
                                    <td> 11</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>D7</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>RST 18H</td>
                                    <td> 11</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>DF</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>RST 20H</td>
                                    <td> 11</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>E7</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>RST 28H</td>
                                    <td> 11</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>EF</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>RST 30H</td>
                                    <td> 11</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>F7</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>RST 38H</td>
                                    <td> 11</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>FF</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr></tr>
                                <tr>
                                    <td>SBC r</td>
                                    <td> 4</td>
                                    <td> 1</td>
                                    <td>***V1*</td>
                                    <td>98+rb</td>
                                    <td>Subtract with Carry</td>
                                    <td>A=A-s-CY</td>
                                </tr>

                                <tr>
                                    <td>SBC A,N</td>
                                    <td> 7</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>DE XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>SBC (HL)</td>
                                    <td> 7</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>9E</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>SBC A,(IX+N)</td>
                                    <td> 19</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>DD 9E XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>SBC A,(IY+N)</td>
                                    <td> 19</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>FD 9E XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>SBC HL,BC</td>
                                    <td> 15</td>
                                    <td> 2</td>
                                    <td>**?V1*</td>
                                    <td>ED 42</td>
                                    <td>Subtract with Carry</td>
                                    <td>HL=HL-ss-CY</td>
                                </tr>
                                <tr>
                                    <td>SBC HL,DE</td>
                                    <td> 15</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>ED 52</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>SBC HL,HL</td>
                                    <td> 15</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>ED 62</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>SBC HL,SP</td>
                                    <td> 15</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>ED 72</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr></tr>
                                <tr>
                                    <td>SCF</td>
                                    <td> 4</td>
                                    <td> 1</td>
                                    <td>--0-01</td>
                                    <td>37</td>
                                    <td>Set Carry Flag</td>
                                    <td>CY=1</td>
                                </tr>
                                <tr></tr>
                                <tr>
                                    <td>SET b,r</td>
                                    <td> 8</td>
                                    <td> 2</td>
                                    <td>------</td>
                                    <td>CB C0+8*b+rb</td>
                                    <td>Set bit</td>
                                    <td>m=mv{2^b}</td>
                                </tr>

                                <tr>
                                    <td>SET b,(HL)</td>
                                    <td> 15</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>CB C6+8*b</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>SET b,(IX+N)</td>
                                    <td> 23</td>
                                    <td> 4</td>
                                    <td></td>
                                    <td>DD CB</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td>XX C6+8*b</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>SET b,(IY+N)</td>
                                    <td> 23</td>
                                    <td> 4</td>
                                    <td></td>
                                    <td>FD CB</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td>XX C6+8*b</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr></tr>
                                <tr>
                                    <td>SLA r</td>
                                    <td> 8</td>
                                    <td> 2</td>
                                    <td>**0P0*</td>
                                    <td>CB 20+rb</td>
                                    <td>Shift Left Arithmetic</td>
                                    <td>m=m*2</td>
                                </tr>

                                <tr>
                                    <td>SLA (HL)</td>
                                    <td> 15</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>CB 26</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>SLA (IX+N)</td>
                                    <td> 23</td>
                                    <td> 4</td>
                                    <td></td>
                                    <td>DD CB XX 26</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>SLA (IY+N)</td>
                                    <td> 23</td>
                                    <td> 4</td>
                                    <td></td>
                                    <td>FD CB XX 26</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>SRA r</td>
                                    <td> 8</td>
                                    <td> 2</td>
                                    <td>**0P0*</td>
                                    <td>CB 28+rb</td>
                                    <td>Shift Right Arith.</td>
                                    <td>m=m/2</td>
                                </tr>

                                <tr>
                                    <td>SRA (HL)</td>
                                    <td> 15</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>CB 2E</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>SRA (IX+N)</td>
                                    <td> 23</td>
                                    <td> 4</td>
                                    <td></td>
                                    <td>DD CB XX 2E</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>SRA (IY+N)</td>
                                    <td> 23</td>
                                    <td> 4</td>
                                    <td></td>
                                    <td>FD CB XX 2E</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr></tr>
                                <tr>
                                    <td>SLL r</td>
                                    <td> 8</td>
                                    <td> 2</td>
                                    <td>**0P0*</td>
                                    <td>CB 30+rb</td>
                                    <td>Shift Left Logical*</td>
                                    <td>m={0,m,CY}<-</td>
                                </tr>

                                <tr>
                                    <td>SLL (HL)</td>
                                    <td> 15</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>CB 36</td>
                                    <td></td>
                                    <td> (SLL instructions</td>
                                </tr>
                                <tr>
                                    <td>SLL (IX+N)</td>
                                    <td> 23</td>
                                    <td> 4</td>
                                    <td></td>
                                    <td>DD CB XX 36</td>
                                    <td></td>
                                    <td> are Unsupported)</td>
                                </tr>

                                <tr>
                                    <td>SLL (IY+N)</td>
                                    <td> 23</td>
                                    <td> 4</td>
                                    <td></td>
                                    <td>FD CB XX 36</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>SRL r</td>
                                    <td> 8</td>
                                    <td> 2</td>
                                    <td>**0P0*</td>
                                    <td>CB 38+rb</td>
                                    <td>Shift Right Logical</td>
                                    <td>m=->{0,m,CY}</td>
                                </tr>

                                <tr>
                                    <td>SRL (HL)</td>
                                    <td> 15</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>CB 3E</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>SRL (IX+N)</td>
                                    <td> 23</td>
                                    <td> 4</td>
                                    <td></td>
                                    <td>DD CB XX 3E</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>SRL (IY+N)</td>
                                    <td> 23</td>
                                    <td> 4</td>
                                    <td></td>
                                    <td>FD CB XX 3E</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr></tr>
                                <tr>
                                    <td>SUB r</td>
                                    <td> 4</td>
                                    <td> 1</td>
                                    <td>***V1*</td>
                                    <td>90+rb</td>
                                    <td>Subtract</td>
                                    <td>A=A-s</td>
                                </tr>

                                <tr>
                                    <td>SUB N</td>
                                    <td> 7</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>D6 XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>SUB (HL)</td>
                                    <td> 7</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>96</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>SUB (IX+N)</td>
                                    <td> 19</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>DD 96 XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>SUB (IY+N)</td>
                                    <td> 19</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>FD 96 XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr></tr>
                                <tr>
                                    <td>XOR r</td>
                                    <td> 4</td>
                                    <td> 1</td>
                                    <td>***P00</td>
                                    <td>A8+rb</td>
                                    <td>Logical Exclusive OR</td>
                                    <td>A=Axs</td>
                                </tr>
                                <tr>
                                    <td>XOR N</td>
                                    <td> 7</td>
                                    <td> 2</td>
                                    <td></td>
                                    <td>EE XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>XOR (HL)</td>
                                    <td> 7</td>
                                    <td> 1</td>
                                    <td></td>
                                    <td>AE</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td>XOR (IX+N)</td>
                                    <td> 19</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>DD AE XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>

                                <tr>
                                    <td>XOR (IY+N)</td>
                                    <td> 19</td>
                                    <td> 3</td>
                                    <td></td>
                                    <td>FD AE XX</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                                <tr></tr>
                            </table>


                            <p>La leyenda para interpretar esta tabla es la siguiente:</p>

                            <table class="flags">
                                <tr>
                                    <th>Símbolo</th>
                                    <th>Significado</th>
                                </tr>
                                <tr></tr>
                                <tr>
                                    <td>n</td>
                                    <td>Immediate addressing</td>
                                </tr>
                                <tr>
                                    <td>nn</td>
                                    <td>Immediate extended addressing</td>
                                </tr>
                                <tr>
                                    <td>e</td>
                                    <td>Relative addressing (PC=PC+2+offset)</td>
                                </tr>
                                <tr>
                                    <td>(nn)</td>
                                    <td>Extended addressing</td>
                                </tr>

                                <tr>
                                    <td>(xx+d)</td>
                                    <td>Indexed addressing</td>
                                </tr>
                                <tr>
                                    <td>r</td>
                                    <td>Register addressing</td>
                                </tr>
                                <tr>
                                    <td>(rr)</td>
                                    <td>Register indirect addressing</td>
                                </tr>
                                <tr>
                                    <td></td>
                                    <td>Implied addressing</td>
                                </tr>
                                <tr>
                                    <td>b</td>
                                    <td>Bit addressing</td>
                                </tr>
                                <tr>
                                    <td>p</td>
                                    <td>Modified page zero addressing (see RST)</td>
                                </tr>

                                <tr>
                                    <td>*</td>
                                    <td>Undocumented opcode</td>
                                </tr>
                                <tr></tr>
                                <tr>
                                    <td>A B C D E</td>
                                    <td>Registers (8-bit)</td>
                                </tr>
                                <tr>
                                    <td>AF BC DE HL</td>
                                    <td>Register pairs (16-bit)</td>
                                </tr>
                                <tr>
                                    <td>F</td>
                                    <td>Flag register (8-bit)</td>
                                </tr>
                                <tr>
                                    <td>I</td>
                                    <td>Interrupt page address register (8-bit)</td>
                                </tr>
                                <tr>
                                    <td>IX IY</td>
                                    <td>Index registers (16-bit)</td>
                                </tr>

                                <tr>
                                    <td>PC</td>
                                    <td>Program Counter register (16-bit)</td>
                                </tr>
                                <tr>
                                    <td>R</td>
                                    <td>Memory Refresh register</td>
                                </tr>
                                <tr>
                                    <td>SP</td>
                                    <td>Stack Pointer register (16-bit)</td>
                                </tr>
                                <tr></tr>
                                <tr>
                                    <td>b</td>
                                    <td>One bit (0 to 7)</td>
                                </tr>
                                <tr>
                                    <td>cc</td>
                                    <td>Condition (C,M,NC,NZ,P,PE,PO,Z)</td>
                                </tr>
                                <tr>
                                    <td>d</td>
                                    <td>One-byte expression (-128 to +127)</td>
                                </tr>

                                <tr>
                                    <td>dst</td>
                                    <td>Destination s, ss, (BC), (DE), (HL), (nn)</td>
                                </tr>
                                <tr>
                                    <td>e</td>
                                    <td>One-byte expression (-126 to +129)</td>
                                </tr>
                                <tr>
                                    <td>m</td>
                                    <td>Any register r, (HL) or (xx+d)</td>
                                </tr>
                                <tr>
                                    <td>n</td>
                                    <td>One-byte expression (0 to 255)</td>
                                </tr>
                                <tr>
                                    <td>nn</td>
                                    <td>Two-byte expression (0 to 65535)</td>
                                </tr>
                                <tr>
                                    <td>pp</td>
                                    <td>Register pair BC, DE, IX or SP</td>
                                </tr>

                                <tr>
                                    <td>qq</td>
                                    <td>Register pair AF, BC, DE or HL</td>
                                </tr>
                                <tr>
                                    <td>qq'</td>
                                    <td>Alternative register pair AF, BC, DE or HL</td>
                                </tr>
                                <tr>
                                    <td>r</td>
                                    <td>Register A, B, C, D, E, H or L</td>
                                </tr>
                                <tr>
                                    <td>rr</td>
                                    <td>Register pair BC, DE, IY or SP</td>
                                </tr>
                                <tr>
                                    <td>s</td>
                                    <td>Any register r, value n, (HL) or (xx+d)</td>
                                </tr>
                                <tr>
                                    <td>src</td>
                                    <td>Source s, ss, (BC), (DE), (HL), nn, (nn)</td>
                                </tr>

                                <tr>
                                    <td>ss</td>
                                    <td>Register pair BC, DE, HL or SP</td>
                                </tr>
                                <tr>
                                    <td>xx</td>
                                    <td>Index register IX or IY</td>
                                </tr>
                                <tr></tr>
                                <tr>
                                    <td>+ - * / ^</td>
                                    <td>Add/subtract/multiply/divide/exponent</td>
                                </tr>
                                <tr>
                                    <td>& ~ v x</td>
                                    <td>Logical AND/NOT/inclusive OR/exclusive OR</td>
                                </tr>
                                <tr>
                                    <td><- -></td>
                                    <td>Rotate left/right</td>
                                </tr>
                                <tr>
                                    <td>( )</td>
                                    <td>Indirect addressing</td>
                                </tr>

                                <tr>
                                    <td>( )+ -( )</td>
                                    <td>Indirect addressing auto-increment/decrement</td>
                                </tr>
                                <tr>
                                    <td>{ }</td>
                                    <td>Combination of operands</td>
                                </tr>
                                <tr>
                                    <td>#</td>
                                    <td>Also BC=BC-1,DE=DE-1</td>
                                </tr>
                                <tr>
                                    <td>##</td>
                                    <td>Only lower 4 bits of accumulator A used</td>
                                </tr>
                            </table>

                            <p>Unos apuntes sobre esta tabla:</p>

                            1.- En instrucciones como "ADC A, r" podemos ver una defición del OPCODE como "88+rb".</p>
                            En este caso, el opcode final se obtendría sumando a "88h" un valor de 0 a 7 según
                            el registro al que nos referimos:</p>

                            <table class="flags">
                                <tr>
                                    <th>Registro</th>
                                    <th>Valor RB</th>
                                </tr>
                                <tr>
                                    <td>A</td>
                                    <td>7</td>
                                </tr>
                                <tr>
                                    <td>B</td>
                                    <td>0</td>
                                </tr>
                                <tr>
                                    <td>C</td>
                                    <td>1</td>
                                </tr>

                                <tr>
                                    <td>D</td>
                                    <td>2</td>
                                </tr>
                                <tr>
                                    <td>E</td>
                                    <td>3</td>
                                </tr>
                                <tr>
                                    <td>H</td>
                                    <td>4</td>
                                </tr>
                                <tr>
                                    <td>L</td>
                                    <td>5</td>
                                </tr>
                                <tr>
                                    <td>(HL)</td>
                                    <td>6</td>
                                </tr>
                            </table>

                            <p>Por ejemplo, "ADC A, B" se codificaría en memoria como "88+0=88".</p>


                            2.- En los saltos hay 2 tiempos de ejecución diferentes (por ejemplo, 10/1). En este
                            caso el valor más alto (10) son los t-estados o ciclos que toma la instrucción cuando
                            el salto se realiza, y el más bajo (1) es lo que tarda la instrucción cuando no se
                            salta al destino. Como véis, a la hora de programar una rutina que tenga saltos o
                            bifurcaciones, es interesante programarla de forma que el caso más común, el que se
                            produzca la mayoría de las veces, no produzca un salto.</p>

                            3.- La descripción de las afectaciones de flags son las siguientes:</p>

                            <table border="0" cellspacing="0" cellpadding="4" width="100%" bgcolor="#EAE8A9">
                                <tr>
                                    <td><p class="codigo">
                                        <pre>
--------+-------+----------------------------------------------
| F     | -*01? |Flag unaffected/affected/reset/set/unknown   |
| S     | S     |Sign flag (Bit 7)                            |
| Z     |  Z    |Zero flag (Bit 6)                            |
| HC    |   H   |Half Carry flag (Bit 4)                      |
| P/V   |    P  |Parity/Overflow flag (Bit 2, V=overflow)     |
| N     |     N |Add/Subtract flag (Bit 1)                    |
| CY    |      C|Carry flag (Bit 0)                           |
+---------------+---------------------------------------------+
</pre>
                                        </p></td>
                                </tr>

                            </table>


                            <p><b> Instrucciones no documentadas del Z80 </b></p>


                            <p>En Internet podemos encontrar gran cantidad de documentación acerca del Z80
                                y su juego de instrucciones, incluyendo las especificaciones oficiales del
                                microprocesador Z80 de Zilog.

                            <p>No obstante, existen una serie de instrucciones u opcodes que el microprocesador
                                puede ejecutar y que no están detallados en la documentación oficial de Zilog.</p>
                            Con respecto a esto, tenemos la suerte de disponer de algo que los programadores
                            de la época del Spectrum no tenían: una descripción detallada de las instrucciones
                            no documentadas del Z80. Aunque la mayoría son instrucciones repetidas de sus
                            versiones documentadas, hay algunas instrucciones curiosas y a las que tal vez
                            le podamos sacar alguna utilidad.

                            <p>¿Por qué existen estos opcodes y no fueron documentados? Supongo que algunos de
                                ellos no fueron considerados como "merecedores de utilidad alguna" y los ingenieros
                                de Zilog no los documentaron, o tal vez sean simplemente un resultado no previsto
                                de la ejecución del Z80 porque los diseñadores no pensaron que al microprocesador
                                pudieran llegarle dichos códigos. El caso es que para el microprocesador existen
                                "todos" los opcodes, otra cosa es qué haga al leerlos y decodificarlos. En este
                                caso algunos de ellos realizan funciones válidas mientras que otros son el equivalente
                                a ejecutar 2 instrucciones NOP, por ejemplo.</p>

                            <p>¿Cuál es la utilidad de estas instrucciones para los programadores? Para ser
                                sinceros, como programadores con un ensamblador o un ensamblador cruzado, poca.</p>

                            Si haces tus programas desde cero con un programa ensamblador, éste se encargará
                            de la conversión de instrucciones estándar a opcodes, aunque no viene mal conocer
                            la existencia de estas instrucciones. Para los programadores de emuladores y de
                            desensambladores, el conocimiento de estos opcodes es vital.</p>

                            <p>El juego Sabre Wulf, por ejemplo, utiliza una de estas instrucciones en la determinación
                                del camino de uno de los enemigos en pantalla (la instrucción SLL, que veremos a
                                continuación), hasta el punto en que los primeros emuladores de Spectrum emulaban
                                mal este juego hasta que incluyeron dicha instrucción en la emulación.</p>

                            <p>Los "<em>undocumented opcodes</em>" son esencialmente opcodes con prefijos CB, ED, DD o
                                FD
                                que hacen unas determinadas operaciones y que no están incluídos en la "lista oficial"
                                que hemos visto hasta ahora. Todos los ejemplos que veremos a continuación están
                                extraídos del documento "<em>The Undocumented Z80 Documented</em>", de Sean Young.</p>


                            <p><b>Prefijo CB</b></p>

                            <p>Por ejemplo, los opcodes CB 30, CB 31, CB 32, CB 33, CB 34, CB 35, CB 36 y CB 37
                                definen una nueva instrucción: <b>SLL</b>.</p>

                            <table class="flags">
                                <tr>
                                    <th>OPCODE</th>
                                    <th>INSTRUCCION</th>
                                </tr>
                                <tr>
                                    <td>CB 30</td>
                                    <td>SLL B</td>
                                </tr>
                                <tr>
                                    <td>CB 31</td>
                                    <td>SLL C</td>
                                </tr>
                                <tr>
                                    <td>CB 32</td>
                                    <td>SLL D</td>
                                </tr>

                                <tr>
                                    <td>CB 33</td>
                                    <td>SLL E</td>
                                </tr>
                                <tr>
                                    <td>CB 34</td>
                                    <td>SLL H</td>
                                </tr>
                                <tr>
                                    <td>CB 35</td>
                                    <td>SLL L</td>
                                </tr>
                                <tr>
                                    <td>CB 36</td>
                                    <td>SLL (HL)</td>
                                </tr>
                                <tr>
                                    <td>CB 37</td>
                                    <td>SLL A</td>
                                </tr>
                            </table>

                            <p><b>SLL (Shift Logical Left)</b> funciona exactamente igual que SLA salvo porque pone a
                                1 el bit 0 (mientras que SLA lo ponía a 0).</p>


                            <b><p> Prefijos DD y FD</b></p>


                            <p>En general, una instrucción precedida por el opcode DD se ejecuta igual que sin él
                                excepto por las siguientes reglas:</p>

                            <ul>
                                <li>Si la instrucción usaba el registro HL, éste se sustituye por IX (excepto en las
                                    instrucciones EX DE, HL y EXX).
                                </li>

                                <li>Cualquier uso de (HL) se reemplaza por (IX+d), excepto JP (HL).</li>
                                <li>Cualquier acceso a H se reemplaza por IXh (byte alto de IX), excepto en el uso de
                                    (IX+d).
                                </li>
                                <li>Cualquier acceso a L se reemplaza por IXl (byte alto de IX), excepto en el uso de
                                    (IX+d).
                                </li>
                            </ul>

                            <p>Por ejemplo:</p>

                            <table class="flags">
                                <tr>
                                    <th>Sin el prefijo DD</th>
                                    <th>Con el Prefijo DD</th>
                                </tr>
                                <tr>
                                    <td>LD HL, 0</td>
                                    <td>LD IX, 0</td>
                                </tr>

                                <tr>
                                    <td>LD H, A</td>
                                    <td>LD IXh, A</td>
                                </tr>
                                <tr>
                                    <td>LD H, (HL)</td>
                                    <td>LD H, (IX+d)</td>
                                </tr>
                            </table>

                            <p>El caso de FD es exactamente igual que el de DD, pero usando el registro IY en lugar del
                                IX.</p>


                            <p><b>Prefijo ED</b></p>

                            <p>Hay una gran cantidad de instrucciones ED XX indocumentadas. Muchos de ellos realizan
                                la misma función que sus equivalentes sin ED delante, mientras que otros simplemente
                                son leídos y decodificados, resultando, a niveles prácticos, equivalentes a 2
                                instrucciones
                                NOP. Veamos algunos de ellos:</p>

                            <table class="flags">
                                <tr>
                                    <th>OPCODE</th>
                                    <th>Instrucción</th>
                                </tr>
                                <tr>
                                    <td>ED 4C</td>
                                    <td>NEG</td>
                                </tr>
                                <tr>
                                    <td>ED 4E</td>
                                    <td>IM 0</td>
                                </tr>
                                <tr>
                                    <td>ED 44</td>
                                    <td>NEG</td>
                                </tr>
                                <tr>
                                    <td>ED 45</td>
                                    <td>RETN</td>
                                </tr>

                                <tr>
                                    <td>ED 5C</td>
                                    <td>NEG</td>
                                </tr>
                                <tr>
                                    <td>ED 5D</td>
                                    <td>RETN</td>
                                </tr>
                                <tr>
                                    <td>ED 64</td>
                                    <td>NEG</td>
                                </tr>
                                <tr>
                                    <td>ED 65</td>
                                    <td>RETN</td>
                                </tr>
                                <tr>
                                    <td>ED 66</td>
                                    <td>IM 0</td>
                                </tr>
                                <tr>
                                    <td>ED 6C</td>
                                    <td>NEG</td>
                                </tr>

                                <tr>
                                    <td>ED 6D</td>
                                    <td>RETN</td>
                                </tr>
                                <tr>
                                    <td>ED 6E</td>
                                    <td>IM 0</td>
                                </tr>
                                <tr>
                                    <td>ED 70</td>
                                    <td>IN (C) / IN F,(C)</td>
                                </tr>
                                <tr>
                                    <td>ED 71</td>
                                    <td>OUT (C),0</td>
                                </tr>
                                <tr>
                                    <td>ED 74</td>
                                    <td>NEG</td>
                                </tr>
                                <tr>
                                    <td>ED 75</td>
                                    <td>RETN</td>
                                </tr>

                                <tr>
                                    <td>ED 76</td>
                                    <td>IM1</td>
                                </tr>
                                <tr>
                                    <td>ED 77</td>
                                    <td>NOP</td>
                                </tr>
                                <tr>
                                    <td>ED 7C</td>
                                    <td>NEG</td>
                                </tr>
                                <tr>
                                    <td>ED 7D</td>
                                    <td>RETN</td>
                                </tr>
                                <tr>
                                    <td>ED 7E</td>
                                    <td>IM2</td>
                                </tr>
                                <tr>
                                    <td>ED 7F</td>
                                    <td>NOP</td>
                                </tr>

                            </table>

                            <p>Aparte de los duplicados de NOP, NEG, IM0, etc, podemos ver un par de instrucciones
                                curiosas y que nos pueden ser de utilidad. Por ejemplo:</p>

                            <table border="0" cellspacing="0" cellpadding="4" width="100%" bgcolor="#EAE8A9">
                                <tr>
                                    <td><p class="codigo">
                                        <pre>
ED 70       IN (C)
</pre>
                                        </p></td>
                                </tr>
                            </table>


                            <p>Esta instrucción lee el puerto C, pero no almacena el resultado de la lectura en
                                ningún lugar. No obstante, altera los flags del registro F como corresponde al
                                resultado leído. Puede ser interesante si sólo nos interesa, por ejemplo, si el
                                valor leído es cero o no (flag Z), y no queremos perder un registro para almacenar
                                el resultado.</p>


                            <p><b>Prefijos DDCB y FDCB</b></p>

                            <p>Las instrucciones DDCB y FDCB no documentadas almacenan el resultado de la
                                operación de la instrucción equivalente sin prefijo (si existe dicho resultado)
                                en uno de los registros de propósito general: B, C, D, E, H, L, ninguno o A,
                                según los 3 bits más bajos del último byte del opcode (000=B, 001=C, 010=D, etc).</p>

                            <p>Así, supongamos el siguiente opcode sí documentado:</p>

                            <table border="0" cellspacing="0" cellpadding="4" width="100%" bgcolor="#EAE8A9">
                                <tr>
                                    <td><p class="codigo">
                                        <pre>
DD CB 01 06         RLC (IX+01h)

</pre>
                                        </p></td>
                                </tr>
                            </table>

                            <p>Si hacemos los 3 últimos bits de dicho opcode 010 (010), el resultado de la
                                operación se copia al registro D (010 = D en nuestra definición anterior), con
                                lo que realmente, en lugar de "RLC (IX+01h)" se ejecuta:</p>

                            <table border="0" cellspacing="0" cellpadding="4" width="100%" bgcolor="#EAE8A9">
                                <tr>
                                    <td><p class="codigo">
                                        <pre>
LD D, (IX+01h)
RLC D
LD (IX+01h), D
</pre>
                                        </p></td>
                                </tr>
                            </table>

                            <p>La notación que sugiere <em>Sean Young</em> para estos opcodes es: "RLC (IX+01h), D".</p>


                            <p>Con el prefijo FDCB ocurre igual que con DDCB, salvo que se usa el registro IY
                                en lugar de IX.</p>


                            <p><b> De la teoria a la practica </b></p>


                            <p>Con este capítulo hemos cubierto el 99% de las instrucciones soportadas
                                por el microprocesador Z80. Con la excepción de los <em>Modos de Interrupciones</em>
                                del Z80 y sus aplicaciones, ya tenemos a nuestra disposición las piezas
                                básicas para formar cualquier programa o rutina en ensamblador.</p>

                            <p>No obstante, todavía quedan por delante muchas horas de programación
                                para dominar este lenguaje, así como diferentes técnicas, trucos,
                                rutinas y mapas de memoria que nos permitan dibujar nuestros gráficos,
                                realizar rutinas complejas, utilizar el sistema de interrupciones del
                                microprocesador para realizar controles de temporización de nuestros
                                programas, o reproducir sonido.</p>


                            <p><strong>FICHEROS</strong></p>
                            <ul>
                                <li><a href="src/06_reset.asm" onclick="window.open(this.href); return false;">Ejemplo
                                    de reset por el mal uso de la pila</a>.
                                </li>

                                <li><a href="src/06_reset.tap" onclick="window.open(this.href); return false;">Fichero
                                    tap del ejemplo reset.asm</a>.
                                </li>
                                <li><a href="src/06_call_nz.asm" onclick="window.open(this.href); return false;">Experimentando
                                    con CALL NZ</a>.
                                </li>
                                <li><a href="src/06_call_nz.tap" onclick="window.open(this.href); return false;">Fichero
                                    tap del ejemplo call_nz.asm</a>.
                                </li>
                                <li><a href="src/06_fade.asm" onclick="window.open(this.href); return false;">Sencillo
                                    fundido de pantalla</a>.
                                </li>
                                <li><a href="src/06_fade.tap" onclick="window.open(this.href); return false;">Fichero
                                    tap del ejemplo fade.asm</a>.
                                </li>

                                <li><a href="src/07_borde.asm" onclick="window.open(this.href); return false;">Cambiando
                                    el borde (ASM).</a>.
                                </li>
                                <li><a href="src/07_borde.tap" onclick="window.open(this.href); return false;">Fichero
                                    tap del ejemplo borde.asm</a>.
                                </li>
                            </ul>
                            <p><strong>LINKS</strong></p>
                            <ul>
                                <li><a href="http://www.worldofspectrum.org/ZXSpectrum128+3Manual/chapter8pt28.html"
                                       onclick="window.open(this.href); return false;">Set de caracteres</a>.
                                </li>
                                <li><a href="http://www.z80.info/" onclick="window.open(this.href); return false;">Web
                                    del Z80</a>.
                                </li>

                                <li><a href="http://www.worldofspectrum.org/faq/reference/z80reference.htm"
                                       onclick="window.open(this.href); return false;">Z80 Reference de WOS</a>.
                                </li>
                                <li><a href="http://ti86.acz.org/z80_ref.htm"
                                       onclick="window.open(this.href); return false;">Z80 Reference de TI86</a>.
                                </li>
                                <li><a href="http://icarus.ticalc.org/articles/z80_faq.html"
                                       onclick="window.open(this.href); return false;">FAQ de Icarus Productions</a>.
                                </li>
                                <li><a href="http://www.speccy.org/trastero/cosas/Fichas/fichas.htm"
                                       onclick="window.open(this.href); return false;">Microfichas de CM de
                                    MicroHobby</a>.
                                </li>
                                <li><a href="http://www.z80.info/lesson1.htm"
                                       onclick="window.open(this.href); return false;">Curso de ASM de z80.info</a>.
                                </li>

                                <li><a href="http://www.arrakis.es/~ninsesabe/pasmo/"
                                       onclick="window.open(this.href); return false;">Ensamblador PASMO</a>.
                                </li>
                                <li><a href="http://www.worldofspectrum.org/ZXSpectrum128+3Manual/chapter8pt23.html">Manual
                                    +3: Puertos E/S</a>.
                                </li>
                                <li><a href="http://www.worldofspectrum.org/ZXSpectrum128+3Manual/chapter8pt28.html">Manual
                                    +3: Set de caracteres</a>.
                                </li>
                                <li><a href="http://www.ticalc.org/pub/text/z80/">Tablas de ensamblado y t-estados</a>
                                    (pulsar en z80.txt, z80_reference.txt, z80time.txt).
                                <li><a href="http://www.myquest.nl/z80undocumented/z80-documented.pdf">Instrucciones no
                                    documentadas</a>.
                                <li><a href="http://www.z80.info/zip/z80-documented.pdf">Instrucciones no
                                    documentadas</a>.


                            </ul>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td align="right"><br><br>Santiago Romero</td>
                </tr>
            </table>
        </td>
    </tr>

    <tr>
        <td> </td>
    </tr>
    <tr>
        <td>
            <script language="JavaScript">
              function RecargarPie(url) {
                document.location = url;
              }
            </script>
            <table border="0" cellspacing="0" cellpadding="6" width="720" class="texto" bgcolor="#DDDDDD">
                <form name="selector_secciones">
                    <tr>
                        <td align="left">
                            <input type="button" onclick="RecargarCabecera('z88dk.html');" name="anterior" value="<"/>
                            <select onChange="RecargarCabecera(this.options[this.selectedIndex].value);">

                                <option value="index.html">Portada</option>
                                <option value="editorial.html">Índice - Editorial</option>
                                <option value="panorama.html">Panorama</option>
                                <option value="la-historia-del-spectrum.html">La historia del Spectrum</option>
                                <option value="el-aventurero.html">El Aventurero</option>
                                <option value="analisis.html">Análisis</option>

                                <option value="computone.html">Computone</option>
                                <option value="al-descubierto.html">Al Descubierto</option>
                                <option value="basic.html">Programación BASIC</option>
                                <option value="z88dk.html">Programación Z88DK</option>
                                <option value="ensamblador.html" selected>Programación Ensamblador</option>
                                <option value="128k-mode.html">128K MODE</option>

                                <option value="input.html">INPUT</option>
                                <option value="tira-comica.html">Tira cómica</option>
                                <option value="opinion.html">Opinión</option>
                            </select>
                            <input type="button" onclick="RecargarCabecera('128k-mode.html');" name="siguiente"
                                   value=">"/>
                        </td>
                        <td align="right" class="texto">
                            <a href="#arriba">Volver arriba</a>

                        </td>
                    </tr>
                    <tr>
                        <td colspan="2" align="center" bgcolor="#FFFFFF" class="texto">> <a href="/lista-revistas.html"><b>ÍNDICE
                            DE REVISTAS</b></a> <
                        </td>
                    </tr>
                </form>
            </table>
        </td>
    </tr>

    <tr>
        <td>
            <table border="0" cellspacing="0" cellpadding="4" width="720" bgcolor="#EEEEEE" class="texto">
                <tr align="center" valign="center">
                    <td>2003-2009 Magazine ZX</td>
                </tr>
            </table>
            <script type="text/javascript">
              var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
              document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
            </script>
            <script type="text/javascript">
              try {
                var pageTracker = _gat._getTracker("UA-8018503-4");
                pageTracker._trackPageview();
              } catch (err) {
              }</script>

        </td>
    </tr>
</table>

</body>
</html>
